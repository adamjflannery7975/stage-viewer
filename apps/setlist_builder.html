<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChordPro Studio â€“ Setlist Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --card:#1f2430;
      --text:#f5f7ff;
      --muted:#aab2c5;
      --border:rgba(255,255,255,0.10);
      --accent:#6aa3ff;
      --accent2:#7ee787;
      --danger:#ff6a6a;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    body.light{
      --bg:#f2f3f6;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#121418;
      --muted:#5c6472;
      --border:rgba(0,0,0,0.12);
      --accent:#2a66ff;
      --accent2:#1f8a3b;
      --danger:#c92828;
      --shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:10px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .brand{
      font-weight:800;
      margin-right:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }

    button, input{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      outline:none;
    }
    button{ cursor:pointer; }
    button:hover{ border-color:rgba(255,255,255,0.22); }
    body.light button:hover{ border-color:rgba(0,0,0,0.22); }

    .btnPrimary{
      border-color: rgba(106,163,255,0.45);
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px;
    }

    .status{
      color: var(--muted);
      font-size: 13px;
      margin: 10px 0 12px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 6px 0 12px;
    }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      font-size:12px;
    }
    body.light .chip{ background: rgba(0,0,0,0.03); }

    .grid{
      display:grid;
      grid-template-columns: 320px 320px 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,0.02);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    body.light .panelHead{ background: rgba(0,0,0,0.03); }
    .panelHead h3{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    .panelBody{
      padding: 10px 10px 12px;
    }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 10px;
      align-items:center;
    }

    .list{
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: var(--card);
    }
    .item{
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .item:last-child{ border-bottom:none; }
    .item:hover{ background: rgba(106,163,255,0.10); }
    body.light .item:hover{ background: rgba(42,102,255,0.08); }
    .item.selected{ background: rgba(126,231,135,0.10); }
    body.light .item.selected{ background: rgba(31,138,59,0.08); }

    .itemTitle{
      font-weight:800;
      font-size: 14px;
    }
    .itemSub{
      color: var(--muted);
      font-size: 12px;
    }
    .badge{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .split{ grid-template-columns: 1fr; }
    }

    table{
      width:100%;
      border-collapse:collapse;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background: var(--card);
    }
    th, td{
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:14px;
      vertical-align:top;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      background: rgba(255,255,255,0.02);
    }
    body.light th{ background: rgba(0,0,0,0.03); }
    tr:last-child td{ border-bottom:none; }
    tr.click{ cursor:pointer; }
    tr.click:hover td{ background: rgba(106,163,255,0.10); }
    body.light tr.click:hover td{ background: rgba(42,102,255,0.08); }

    .warn{ color: var(--danger); font-weight: 800; }
    .muted{ color: var(--muted); }

    .smallHelp{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">Setlist Builder</div>
    <button id="themeBtn">Toggle Theme</button>
    <span class="chip" id="modeChip">Mode: https://</span>
    <button id="reloadBtn">Reload</button>
    <button id="downloadBtn" class="btnPrimary">Download setlists.json</button>
  </header>

  <div class="wrap">
    <div class="status" id="status">Loadingâ€¦</div>

    <div class="chips" id="chips"></div>

    <div class="grid">
      <!-- Collections -->
      <div class="panel">
        <div class="panelHead">
          <h3>Collections</h3>
          <div class="row" style="margin:0;">
            <button id="addCollectionBtn">Add</button>
            <button id="renameCollectionBtn">Rename</button>
            <button id="deleteCollectionBtn">Delete</button>
          </div>
        </div>
        <div class="panelBody">
          <input id="filterCollections" placeholder="Filter collectionsâ€¦" style="width:100%; margin-bottom:10px;">
          <div class="list" id="collectionsList"></div>
          <div class="smallHelp">
            Tip: <b>All Songs</b> is smart (auto) and not editable here.
          </div>
        </div>
      </div>

      <!-- Sets -->
      <div class="panel">
        <div class="panelHead">
          <h3>Sets in Collection</h3>
          <div class="row" style="margin:0;">
            <button id="addSetBtn">Add Set</button>
            <button id="renameSetBtn">Rename</button>
            <button id="deleteSetBtn">Delete</button>
          </div>
        </div>
        <div class="panelBody">
          <div class="row" style="margin-top:0;">
            <button id="setUpBtn" title="Move set up">â†‘</button>
            <button id="setDownBtn" title="Move set down">â†“</button>
            <span class="badge" id="selectedCollectionBadge">No collection selected</span>
          </div>

          <div class="list" id="setsList"></div>

          <div class="smallHelp">
            Smart collection sets are generated at runtime.<br>
            For list collections, edit sets and songs.
          </div>
        </div>
      </div>

      <!-- Songs + In Set -->
      <div class="panel">
        <div class="panelHead">
          <h3>Set Songs</h3>
          <div class="row" style="margin:0;">
            <input id="songSearch" placeholder="Search songsâ€¦" style="min-width:220px;">
            <button id="songUpBtn" title="Move selected song up">â†‘</button>
            <button id="songDownBtn" title="Move selected song down">â†“</button>
            <button id="removeSongBtn">Remove</button>
          </div>
        </div>
        <div class="panelBody">
          <div class="split">
            <div>
              <div class="badge" id="libraryBadge" style="margin-bottom:10px;">Library</div>
              <table>
                <thead>
                  <tr>
                    <th style="width:52%;">Song</th>
                    <th style="width:18%;">Singer</th>
                    <th style="width:15%;">Dur</th>
                    <th style="width:15%;">Tempo</th>
                  </tr>
                </thead>
                <tbody id="songsTable"></tbody>
              </table>
              <div class="smallHelp">
                Click a song to add it to the selected set.
              </div>
            </div>

            <div>
              <div class="badge" id="inSetBadge" style="margin-bottom:10px;">In set (ordered)</div>
              <div class="list" id="inSetList"></div>

              <div class="smallHelp">
                Save by downloading <b>setlists.json</b>, then overwrite <b>library/setlists.json</b> in your repo and commit.
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Theme
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('cps_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });
    (function initTheme(){
      const t = localStorage.getItem('cps_theme');
      if (t === 'light') document.body.classList.add('light');
    })();

    // Mode chip
    const modeChip = document.getElementById('modeChip');
    modeChip.textContent = `Mode: ${location.protocol}//`;

    const statusEl = document.getElementById('status');
    const chipsEl = document.getElementById('chips');

    // UI elements
    const collectionsList = document.getElementById('collectionsList');
    const setsList = document.getElementById('setsList');
    const songsTable = document.getElementById('songsTable');
    const inSetList = document.getElementById('inSetList');

    const filterCollections = document.getElementById('filterCollections');
    const songSearch = document.getElementById('songSearch');

    const selectedCollectionBadge = document.getElementById('selectedCollectionBadge');
    const libraryBadge = document.getElementById('libraryBadge');
    const inSetBadge = document.getElementById('inSetBadge');

    const reloadBtn = document.getElementById('reloadBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    const addCollectionBtn = document.getElementById('addCollectionBtn');
    const renameCollectionBtn = document.getElementById('renameCollectionBtn');
    const deleteCollectionBtn = document.getElementById('deleteCollectionBtn');

    const addSetBtn = document.getElementById('addSetBtn');
    const renameSetBtn = document.getElementById('renameSetBtn');
    const deleteSetBtn = document.getElementById('deleteSetBtn');
    const setUpBtn = document.getElementById('setUpBtn');
    const setDownBtn = document.getElementById('setDownBtn');

    const songUpBtn = document.getElementById('songUpBtn');
    const songDownBtn = document.getElementById('songDownBtn');
    const removeSongBtn = document.getElementById('removeSongBtn');

    // State
    let LIB = null;           // library.index.json
    let SETLISTS = null;      // library/setlists.json
    let SONGS = [];           // LIB.songs
    let collections = [];     // normalized "collections" for editing (from setlists.json)

    let selectedCollectionId = null;
    let selectedSetId = null;
    let selectedInSetUid = null;

    function setStatus(msg){ statusEl.textContent = msg; }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function songKey(s){
      const t = (s.title || '').toLowerCase();
      const a = (s.artist || '').toLowerCase();
      return `${t}~~${a}~~${s.uid}`;
    }

    function normalizeCollections(setlistsJson){
      // Expecting:
      // { version, updated, collections: [...] }
      // Always ensure a smart _all_songs exists
      const out = Array.isArray(setlistsJson?.collections) ? JSON.parse(JSON.stringify(setlistsJson.collections)) : [];

      const hasAll = out.some(c => c && c.id === '_all_songs');
      if (!hasAll){
        out.unshift({
          id: '_all_songs',
          type: 'smart',
          name: 'All Songs',
          rules: { mode: 'all_songs' },
          sets: []
        });
      } else {
        // ensure sets exists on _all_songs
        out.forEach(c => {
          if (c.id === '_all_songs' && !('sets' in c)) c.sets = [];
        });
      }
      return out;
    }

    function buildChips(){
      const libSongs = SONGS.length;
      const colCount = collections.length;
      const updated = SETLISTS?.updated || 'â€”';
      chipsEl.innerHTML = `
        <span class="chip">Songs: <b>${libSongs}</b></span>
        <span class="chip">Collections: <b>${colCount}</b></span>
        <span class="chip">Setlists updated: <b>${escapeHtml(updated)}</b></span>
        <span class="chip muted">Tip: Edit â†’ Download â†’ overwrite library/setlists.json â†’ run consolidate</span>
      `;
    }

    function getCollectionById(id){
      return collections.find(c => String(c.id) === String(id));
    }

    function getSelectedCollection(){
      return selectedCollectionId ? getCollectionById(selectedCollectionId) : null;
    }

    function getSelectedSet(){
      const c = getSelectedCollection();
      if (!c || !Array.isArray(c.sets)) return null;
      return c.sets.find(s => String(s.id) === String(selectedSetId));
    }

    function renderCollections(){
      const q = (filterCollections.value || '').trim().toLowerCase();

      collectionsList.innerHTML = '';
      collections
        .filter(c => {
          const name = (c.name || c.id || '').toLowerCase();
          return !q || name.includes(q);
        })
        .forEach(c => {
          const div = document.createElement('div');
          div.className = 'item';
          div.dataset.id = c.id;

          if (String(c.id) === String(selectedCollectionId)) div.classList.add('selected');

          const type = c.type || 'list';
          const setCount = Array.isArray(c.sets) ? c.sets.length : 0;

          div.innerHTML = `
            <div>
              <div class="itemTitle">${escapeHtml(c.name || c.id || '(unnamed)')}</div>
              <div class="itemSub">${escapeHtml(type)} â€¢ ${setCount} set(s)</div>
            </div>
            <span class="badge">${escapeHtml(c.id)}</span>
          `;

          div.addEventListener('click', () => {
            selectedCollectionId = c.id;
            selectedSetId = null;
            selectedInSetUid = null;
            renderAll();
          });

          collectionsList.appendChild(div);
        });
    }

    function renderSets(){
      const c = getSelectedCollection();
      setsList.innerHTML = '';

      if (!c){
        selectedCollectionBadge.textContent = 'No collection selected';
        return;
      }

      selectedCollectionBadge.textContent = `${c.name || c.id} (${c.type || 'list'})`;

      // Smart collection: nothing editable here
      if ((c.type || '').toLowerCase() === 'smart'){
        setsList.innerHTML = `<div style="padding:12px;color:var(--muted)">Smart collection. Sets are generated automatically.</div>`;
        return;
      }

      (c.sets || []).forEach(s => {
        const div = document.createElement('div');
        div.className = 'item';
        div.dataset.id = s.id;

        if (String(s.id) === String(selectedSetId)) div.classList.add('selected');

        const count = Array.isArray(s.songs) ? s.songs.length : 0;

        div.innerHTML = `
          <div>
            <div class="itemTitle">${escapeHtml(s.name || s.id || '(unnamed)')}</div>
            <div class="itemSub">${count} song(s)</div>
          </div>
          <span class="badge">${escapeHtml(s.id)}</span>
        `;

        div.addEventListener('click', () => {
          selectedSetId = s.id;
          selectedInSetUid = null;
          renderAll();
        });

        setsList.appendChild(div);
      });

      if (!selectedSetId && (c.sets || []).length){
        selectedSetId = c.sets[0].id;
      }
    }

    function renderSongsTable(){
      const q = (songSearch.value || '').trim().toLowerCase();

      libraryBadge.textContent = `Library (${SONGS.length})`;

      const visible = SONGS
        .filter(s => {
          if (!q) return true;
          const t = (s.title || '').toLowerCase();
          const a = (s.artist || '').toLowerCase();
          const si = (s.singer || '').toLowerCase();
          return t.includes(q) || a.includes(q) || si.includes(q);
        })
        .sort((a,b)=>songKey(a).localeCompare(songKey(b)));

      songsTable.innerHTML = '';
      visible.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = 'click';

        tr.innerHTML = `
          <td><b>${escapeHtml(s.title || '(untitled)')}</b><div class="muted" style="font-size:12px">${escapeHtml(s.artist || '(unknown)')}</div></td>
          <td>${escapeHtml(s.singer || 'â€”')}</td>
          <td>${escapeHtml(String(s.duration || 'â€”'))}</td>
          <td>${escapeHtml(String((s.tempo ?? 'â€”')))}</td>
        `;

        tr.addEventListener('click', () => addSongToSelectedSet(String(s.uid)));

        songsTable.appendChild(tr);
      });
    }

    function renderInSet(){
      const c = getSelectedCollection();
      const st = getSelectedSet();

      inSetList.innerHTML = '';

      if (!c){
        inSetBadge.textContent = 'In set (no collection)';
        inSetList.innerHTML = `<div style="padding:12px;color:var(--muted)">Select a collection.</div>`;
        return;
      }

      if ((c.type || '').toLowerCase() === 'smart'){
        inSetBadge.textContent = 'Smart collection (All Songs)';
        inSetList.innerHTML = `<div style="padding:12px;color:var(--muted)">Nothing to edit here.</div>`;
        return;
      }

      if (!st){
        inSetBadge.textContent = 'In set (no set selected)';
        inSetList.innerHTML = `<div style="padding:12px;color:var(--muted)">Select a set.</div>`;
        return;
      }

      const uids = Array.isArray(st.songs) ? st.songs.map(String) : [];
      inSetBadge.textContent = `In set: ${st.name || st.id} (${uids.length})`;

      if (!uids.length){
        inSetList.innerHTML = `<div style="padding:12px;color:var(--muted)">No songs yet. Click songs on the left to add.</div>`;
        return;
      }

      uids.forEach(uid => {
        const s = SONGS.find(x => String(x.uid) === String(uid));
        const div = document.createElement('div');
        div.className = 'item';
        div.dataset.uid = uid;
        if (String(uid) === String(selectedInSetUid)) div.classList.add('selected');

        if (!s){
          div.innerHTML = `
            <div>
              <div class="itemTitle warn">Missing song</div>
              <div class="itemSub">${escapeHtml(uid)}</div>
            </div>
            <span class="badge">UID</span>
          `;
        } else {
          div.innerHTML = `
            <div>
              <div class="itemTitle">${escapeHtml(s.title || '(untitled)')}</div>
              <div class="itemSub">${escapeHtml(s.artist || '(unknown)')} â€¢ ðŸŽ¤ ${escapeHtml(s.singer || 'â€”')}</div>
            </div>
            <span class="badge">${escapeHtml(String(s.duration || 'â€”'))}</span>
          `;
        }

        div.addEventListener('click', () => {
          selectedInSetUid = uid;
          renderInSet(); // just redraw selection highlight
        });

        inSetList.appendChild(div);
      });
    }

    function addSongToSelectedSet(uid){
      const c = getSelectedCollection();
      const st = getSelectedSet();
      if (!c) return alert('Select a collection first.');
      if ((c.type || '').toLowerCase() === 'smart') return alert('All Songs is smart and not editable.');
      if (!st) return alert('Select a set first.');

      st.songs = Array.isArray(st.songs) ? st.songs : [];
      st.songs.push(String(uid));
      selectedInSetUid = String(uid);
      renderInSet();
    }

    function moveSet(delta){
      const c = getSelectedCollection();
      if (!c || (c.type || '').toLowerCase() === 'smart') return;
      if (!selectedSetId) return;

      const idx = (c.sets || []).findIndex(s => String(s.id) === String(selectedSetId));
      if (idx < 0) return;
      const next = Math.min(Math.max(idx + delta, 0), c.sets.length - 1);
      if (idx === next) return;

      const [it] = c.sets.splice(idx, 1);
      c.sets.splice(next, 0, it);
      renderSets();
      renderInSet();
    }

    function moveSong(delta){
      const c = getSelectedCollection();
      const st = getSelectedSet();
      if (!c || (c.type || '').toLowerCase() === 'smart') return;
      if (!st) return;
      if (!selectedInSetUid) return;

      const arr = Array.isArray(st.songs) ? st.songs.map(String) : [];
      const idx = arr.findIndex(x => String(x) === String(selectedInSetUid));
      if (idx < 0) return;

      const next = Math.min(Math.max(idx + delta, 0), arr.length - 1);
      if (idx === next) return;

      const [it] = arr.splice(idx, 1);
      arr.splice(next, 0, it);
      st.songs = arr;
      renderInSet();
    }

    function removeSelectedSong(){
      const c = getSelectedCollection();
      const st = getSelectedSet();
      if (!c || (c.type || '').toLowerCase() === 'smart') return;
      if (!st) return;
      if (!selectedInSetUid) return;

      const arr = Array.isArray(st.songs) ? st.songs.map(String) : [];
      const idx = arr.findIndex(x => String(x) === String(selectedInSetUid));
      if (idx < 0) return;
      arr.splice(idx, 1);
      st.songs = arr;
      selectedInSetUid = null;
      renderInSet();
    }

    function promptText(title, def){
      const v = prompt(title, def || '');
      if (v === null) return null;
      const t = v.trim();
      return t ? t : null;
    }

    function slugId(name){
      return name.toLowerCase()
        .replace(/[^a-z0-9]+/g,'_')
        .replace(/^_+|_+$/g,'')
        .slice(0, 40) || ('c_' + Math.random().toString(16).slice(2, 8));
    }

    function addCollection(){
      const name = promptText('Collection name?', 'New Collection');
      if (!name) return;
      const id = slugId(name);
      if (collections.some(c => c.id === id)) return alert('That id already exists. Try a different name.');

      collections.push({
        id,
        type: 'list',
        name,
        tags: [],
        sets: [{ id: 'main', name, songs: [] }]
      });

      selectedCollectionId = id;
      selectedSetId = 'main';
      selectedInSetUid = null;
      renderAll();
    }

    function renameCollection(){
      const c = getSelectedCollection();
      if (!c) return alert('Select a collection first.');
      if (c.id === '_all_songs') return alert('All Songs is smart and not editable.');

      const name = promptText('New collection name?', c.name || c.id);
      if (!name) return;
      c.name = name;
      renderCollections();
      renderSets();
      renderInSet();
    }

    function deleteCollection(){
      const c = getSelectedCollection();
      if (!c) return alert('Select a collection first.');
      if (c.id === '_all_songs') return alert('All Songs is smart and not deletable.');

      if (!confirm(`Delete collection "${c.name || c.id}"?`)) return;
      collections = collections.filter(x => x.id !== c.id);

      selectedCollectionId = '_all_songs';
      selectedSetId = null;
      selectedInSetUid = null;
      renderAll();
    }

    function addSet(){
      const c = getSelectedCollection();
      if (!c) return alert('Select a collection first.');
      if ((c.type || '').toLowerCase() === 'smart') return alert('Smart collections cannot be edited.');

      const name = promptText('Set name?', `Set ${(c.sets || []).length + 1}`);
      if (!name) return;

      const id = slugId(name);
      c.sets = Array.isArray(c.sets) ? c.sets : [];
      if (c.sets.some(s => s.id === id)) return alert('Set id already exists in this collection.');

      c.sets.push({ id, name, songs: [] });
      selectedSetId = id;
      selectedInSetUid = null;
      renderSets();
      renderInSet();
    }

    function renameSet(){
      const c = getSelectedCollection();
      const st = getSelectedSet();
      if (!c || (c.type || '').toLowerCase() === 'smart') return;
      if (!st) return alert('Select a set first.');

      const name = promptText('New set name?', st.name || st.id);
      if (!name) return;
      st.name = name;
      renderSets();
      renderInSet();
    }

    function deleteSet(){
      const c = getSelectedCollection();
      const st = getSelectedSet();
      if (!c || (c.type || '').toLowerCase() === 'smart') return;
      if (!st) return alert('Select a set first.');

      if (!confirm(`Delete set "${st.name || st.id}"?`)) return;
      c.sets = (c.sets || []).filter(x => x.id !== st.id);
      selectedSetId = (c.sets[0] && c.sets[0].id) || null;
      selectedInSetUid = null;
      renderSets();
      renderInSet();
    }

    function buildDownloadJson(){
      // Save collections only (All Songs stays smart)
      const now = new Date().toISOString();
      return {
        version: 1,
        updated: now,
        collections: collections.map(c => {
          // ensure sets exists for all
          const copy = JSON.parse(JSON.stringify(c));
          if (!('sets' in copy)) copy.sets = [];
          return copy;
        })
      };
    }

    function downloadSetlists(){
      const data = buildDownloadJson();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'setlists.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus('Downloaded setlists.json. Overwrite library/setlists.json in your repo, commit, then run consolidate.');
    }

    function renderAll(){
      buildChips();
      renderCollections();
      renderSets();
      renderSongsTable();
      renderInSet();
    }

    async function loadAll(){
      setStatus('Loading library + setlistsâ€¦');

      try{
        LIB = await fetchJSON('../library/library.index.json');
        SONGS = Array.isArray(LIB.songs) ? LIB.songs.slice() : [];

        // setlists.json might not exist on first run
        try{
          SETLISTS = await fetchJSON('../library/setlists.json');
        } catch {
          SETLISTS = { version: 1, updated: new Date().toISOString(), collections: [] };
        }

        collections = normalizeCollections(SETLISTS);

        // Default selection
        if (!selectedCollectionId) selectedCollectionId = '_all_songs';
        if (!getCollectionById(selectedCollectionId)) selectedCollectionId = '_all_songs';

        // Select first set if list collection
        const c = getSelectedCollection();
        if (c && (c.type || '').toLowerCase() !== 'smart' && Array.isArray(c.sets) && c.sets.length){
          if (!selectedSetId) selectedSetId = c.sets[0].id;
        } else {
          selectedSetId = null;
        }

        buildChips();
        renderAll();
        setStatus(`Loaded ${SONGS.length} song(s) and ${collections.length} collection(s). Make changes, then Download setlists.json.`);
      }catch(e){
        console.error(e);
        setStatus(`Failed to load: ${e.message}`);
      }
    }

    // Events
    reloadBtn.addEventListener('click', loadAll);
    downloadBtn.addEventListener('click', downloadSetlists);
    filterCollections.addEventListener('input', renderCollections);
    songSearch.addEventListener('input', renderSongsTable);

    addCollectionBtn.addEventListener('click', addCollection);
    renameCollectionBtn.addEventListener('click', renameCollection);
    deleteCollectionBtn.addEventListener('click', deleteCollection);

    addSetBtn.addEventListener('click', addSet);
    renameSetBtn.addEventListener('click', renameSet);
    deleteSetBtn.addEventListener('click', deleteSet);
    setUpBtn.addEventListener('click', () => moveSet(-1));
    setDownBtn.addEventListener('click', () => moveSet(1));

    songUpBtn.addEventListener('click', () => moveSong(-1));
    songDownBtn.addEventListener('click', () => moveSong(1));
    removeSongBtn.addEventListener('click', removeSelectedSong);

    // Init
    loadAll();
  </script>
</body>
</html>
