<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChordPro Studio – Setlist Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Shared theme helpers -->
  <script src="../shared/theme.js"></script>
  <script src="../shared/apps_nav.js"></script>

  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --card:#1f2430;
      --text:#f5f7ff;
      --muted:#aab2c5;
      --border:rgba(255,255,255,0.10);
      --accent:#6aa3ff;
      --accent2:#7ee787;
      --danger:#ff6a6a;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    body.light{
      --bg:#f2f3f6;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#121418;
      --muted:#5c6472;
      --border:rgba(0,0,0,0.12);
      --accent:#2a66ff;
      --accent2:#1f8a3b;
      --danger:#c92828;
      --shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:20;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .brand{
      font-weight:900;
      letter-spacing:0.2px;
      margin-right:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    button, select, input{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      outline:none;
    }
    button{ cursor:pointer; }
    button:hover{ border-color:rgba(255,255,255,0.22); }
    body.light button:hover{ border-color:rgba(0,0,0,0.22); }

    .btnPrimary{ border-color: rgba(106,163,255,0.45); }
    .btnPrimary:hover{ border-color: rgba(106,163,255,0.85); }
    .btnDanger{ border-color: rgba(255,106,106,0.45); }
    .btnDanger:hover{ border-color: rgba(255,106,106,0.85); }

    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px;
    }

    .hint{
      font-size:13px;
      color:var(--muted);
      margin: 4px 0 12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 330px 330px 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1050px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .panelHeader{
      padding:10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    body.light .panelHeader{ background: rgba(0,0,0,0.03); }
    .panelHeader h3{
      margin:0;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color: var(--muted);
    }
    .panelBody{ padding:10px; }

    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .smallNote{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }

    .list{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: var(--card);
    }
    .listItem{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .listItem:last-child{ border-bottom:none; }
    .listItem:hover{ background: rgba(106,163,255,0.10); }
    body.light .listItem:hover{ background: rgba(42,102,255,0.08); }
    .listItem.selected{ background: rgba(126,231,135,0.10); }
    body.light .listItem.selected{ background: rgba(31,138,59,0.08); }

    .liMain{ display:flex; flex-direction:column; gap:2px; }
    .liTitle{ font-weight:900; font-size:14px; }
    .liSub{ color:var(--muted); font-size:12px; }

    .liTag{
      align-self:center;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color: var(--muted);
      white-space:nowrap;
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
    }
    th, td{
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:14px;
      vertical-align:top;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      background:rgba(255,255,255,0.02);
    }
    body.light th{ background:rgba(0,0,0,0.03); }
    tr:last-child td{ border-bottom:none; }
    tr.clickable{ cursor:pointer; }
    tr.clickable:hover td{ background: rgba(106,163,255,0.10); }
    body.light tr.clickable:hover td{ background: rgba(42,102,255,0.08); }
    tr.selected td{ background: rgba(126,231,135,0.10); }
    body.light tr.selected td{ background: rgba(31,138,59,0.08); }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 1050px){
      .twoCol{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" id="brandHome" title="Apps">Setlist Builder</div>
    <span class="pill" id="modePill">Mode: —</span>
<button id="reloadBtn">Reload</button>
    <button id="downloadBtn" class="btnPrimary">Download setlists.json</button>
    <button id="themeBtn">Toggle Theme</button>
  </header>

  <div class="wrap">
    <div class="hint" id="hint">Loading…</div>

    <div class="grid">
      <!-- Collections -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Collections</h3>
          <span class="pill" id="collectionsPill">—</span>
        </div>
        <div class="panelBody">
          <div class="btnRow">
            <button id="addCollectionBtn">Add</button>
            <button id="renameCollectionBtn">Rename</button>
            <button id="deleteCollectionBtn" class="btnDanger">Delete</button>
          </div>
          <input id="collectionFilter" placeholder="Filter collections…" style="width:100%; margin-bottom:10px;">
          <div class="list" id="collectionsList"></div>

          <div class="smallNote">
            Tip: “All Songs” can be a <b>smart</b> collection and won’t be edited here. List collections hold one or more sets you can build.
          </div>
        </div>
      </div>

      <!-- Sets -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Sets in Collection</h3>
          <span class="pill" id="setsPill">—</span>
        </div>
        <div class="panelBody">
          <div class="btnRow">
            <button id="addSetBtn">Add Set</button>
            <button id="renameSetBtn">Rename</button>
            <button id="deleteSetBtn" class="btnDanger">Delete</button>
            <button id="setUpBtn" title="Move set up">↑</button>
            <button id="setDownBtn" title="Move set down">↓</button>
          </div>
          <div class="list" id="setsList"></div>

          <div class="smallNote" id="setsNote">Select a collection.</div>
        </div>
      </div>

      <!-- Songs -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Set Songs</h3>
          <span class="pill" id="songsPill">—</span>
        </div>
        <div class="panelBody">
          <div class="twoCol">
            <div>
              <input id="songSearch" placeholder="Search songs…" style="width:100%; margin-bottom:10px;">
              <table>
                <thead>
                  <tr>
                    <th style="width:46%;">Song</th>
                    <th style="width:18%;">Singer</th>
                    <th style="width:18%;">Dur</th>
                    <th style="width:18%;">Tempo</th>
                  </tr>
                </thead>
                <tbody id="songTable"></tbody>
              </table>
              <div class="smallNote">Click a song to add it to the selected set.</div>
            </div>

            <div>
              <div class="btnRow" style="justify-content:space-between;">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="inSetUpBtn" title="Move selected song up">↑</button>
                  <button id="inSetDownBtn" title="Move selected song down">↓</button>
                  <button id="removeSongBtn" class="btnDanger">Remove</button>
                </div>
                <span class="pill" id="inSetPill">—</span>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>In Set (ordered)</th>
                  </tr>
                </thead>
                <tbody id="inSetTable"></tbody>
              </table>

              <div class="smallNote" id="smartNote" style="display:none;">
                Smart collection (<b id="smartName">—</b>). Nothing to edit here.
              </div>

              <div class="smallNote" style="margin-top:10px;">
                Save via <b>Download setlists.json</b>, then overwrite <code>library/setlists.json</code> in your repo folder and commit.
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    // --- Shared Theme toggle (UI mode) ---
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      if (window.CPS_THEME && CPS_THEME.getUiMode && CPS_THEME.applyUiMode) {
        const next = (CPS_THEME.getUiMode() === 'light') ? 'dark' : 'light';
        CPS_THEME.applyUiMode(next);
      } else {
        document.body.classList.toggle('light');
      }
    });

    // --- DOM ---
    const modePill = document.getElementById('modePill');
    const hintEl = document.getElementById('hint');
    const reloadBtn = document.getElementById('reloadBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    const collectionsPill = document.getElementById('collectionsPill');
    const collectionsList = document.getElementById('collectionsList');
    const collectionFilter = document.getElementById('collectionFilter');

    const addCollectionBtn = document.getElementById('addCollectionBtn');
    const renameCollectionBtn = document.getElementById('renameCollectionBtn');
    const deleteCollectionBtn = document.getElementById('deleteCollectionBtn');

    const setsPill = document.getElementById('setsPill');
    const setsList = document.getElementById('setsList');
    const setsNote = document.getElementById('setsNote');

    const addSetBtn = document.getElementById('addSetBtn');
    const renameSetBtn = document.getElementById('renameSetBtn');
    const deleteSetBtn = document.getElementById('deleteSetBtn');
    const setUpBtn = document.getElementById('setUpBtn');
    const setDownBtn = document.getElementById('setDownBtn');

    const songsPill = document.getElementById('songsPill');
    const songSearch = document.getElementById('songSearch');
    const songTable = document.getElementById('songTable');

    const inSetPill = document.getElementById('inSetPill');
    const inSetTable = document.getElementById('inSetTable');
    const inSetUpBtn = document.getElementById('inSetUpBtn');
    const inSetDownBtn = document.getElementById('inSetDownBtn');
    const removeSongBtn = document.getElementById('removeSongBtn');

    const smartNote = document.getElementById('smartNote');
    const smartName = document.getElementById('smartName');

    // --- Apps Launcher (shared modal) ---
    function openAppsLauncher(){
      if (window.CPSNav && typeof window.CPSNav.open === 'function') {
        window.CPSNav.open();
      } else {
        // Fallback (should not happen if ../shared/apps_nav.js is present)
        window.location.href = './index.html';
      }
    }


    // --- State ---
    let LIB = null; // library.index.json (songs)
    let SETLISTS = null; // setlists.json (collections)
    let SONGS = []; // from library.index.json
    let SONG_BY_UID = new Map();
    let SONG_BY_SONG = new Map(); // song_uid -> canonical song record

    let currentCollectionId = null;
    let currentSetId = null;
    let selectedInSetUid = null;

    function setHint(msg){ hintEl.textContent = msg; }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function slugId(input){
      return String(input || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,'_')
        .replace(/^_+|_+$/g,'')
        .slice(0,40) || ('id_' + Math.random().toString(16).slice(2,8));
    }

    function nowIso(){
      return new Date().toISOString();
    }

    function getCollections(){
      return Array.isArray(SETLISTS?.collections) ? SETLISTS.collections : [];
    }

    function findCollection(id){
      return getCollections().find(c => String(c.id) === String(id));
    }

    function getSets(col){
      return Array.isArray(col?.sets) ? col.sets : [];
    }

    function findSet(col, setId){
      return getSets(col).find(s => String(s.id) === String(setId));
    }

    function isSmart(col){
      return String(col?.type || '').toLowerCase() === 'smart';
    }

    function refreshPills(){
      collectionsPill.textContent = `Loaded: ${getCollections().length}`;
      songsPill.textContent = `Songs: ${SONGS.length}`;
      const col = findCollection(currentCollectionId);
      const sets = col ? getSets(col) : [];
      setsPill.textContent = col ? `Sets: ${sets.length}` : `—`;

      const set = col ? findSet(col, currentSetId) : null;
      const count = Array.isArray(set?.songs) ? set.songs.length : 0;
      inSetPill.textContent = set ? `In set: ${count}` : `—`;
    }

    function renderCollections(){
      const filter = (collectionFilter.value || '').trim().toLowerCase();
      collectionsList.innerHTML = '';

      const cols = getCollections().filter(c => {
        if (!filter) return true;
        const name = (c.name || c.id || '').toLowerCase();
        return name.includes(filter);
      });

      if (!cols.length){
        collectionsList.innerHTML = `<div style="padding:12px;color:var(--muted)">No collections.</div>`;
        refreshPills();
        return;
      }

      cols.forEach(c => {
        const div = document.createElement('div');
        div.className = 'listItem' + ((String(c.id) === String(currentCollectionId)) ? ' selected' : '');
        div.innerHTML = `
          <div class="liMain">
            <div class="liTitle">${escapeHtml(c.name || c.id || '(collection)')}</div>
            <div class="liSub">${escapeHtml(c.id || '')}</div>
          </div>
          <span class="liTag">${escapeHtml(c.type || 'list')}</span>
        `;
        div.addEventListener('click', () => {
          currentCollectionId = String(c.id);
          localStorage.setItem('cps_sb_collection', currentCollectionId);

          const col = findCollection(currentCollectionId);
          const sets = getSets(col);
          currentSetId = sets[0]?.id ? String(sets[0].id) : null;
          localStorage.setItem('cps_sb_set_' + currentCollectionId, currentSetId || '');

          selectedInSetUid = null;

          renderCollections();
          renderSets();
          renderSongsPanel();
        });
        collectionsList.appendChild(div);
      });

      refreshPills();
    }

    function renderSets(){
      setsList.innerHTML = '';
      setsNote.textContent = '';

      const col = findCollection(currentCollectionId);

      if (!col){
        setsList.innerHTML = `<div style="padding:12px;color:var(--muted)">Select a collection.</div>`;
        refreshPills();
        return;
      }

      if (isSmart(col)){
        setsList.innerHTML = `<div style="padding:12px;color:var(--muted)">Smart collection. Sets are generated at runtime.</div>`;
        setsNote.textContent = 'Smart collection. Set editing is disabled.';
        refreshPills();
        return;
      }

      const sets = getSets(col);
      if (!sets.length){
        setsList.innerHTML = `<div style="padding:12px;color:var(--muted)">No sets in this collection.</div>`;
        setsNote.textContent = 'Add a set to begin.';
        refreshPills();
        return;
      }

      sets.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'listItem' + ((String(s.id) === String(currentSetId)) ? ' selected' : '');
        const count = Array.isArray(s.songs) ? s.songs.length : 0;
        div.innerHTML = `
          <div class="liMain">
            <div class="liTitle">${escapeHtml(s.name || s.id || '(set)')}</div>
            <div class="liSub">${escapeHtml(s.id || '')} • ${count} songs</div>
          </div>
          <span class="liTag">#${idx+1}</span>
        `;
        div.addEventListener('click', () => {
          currentSetId = String(s.id);
          localStorage.setItem('cps_sb_set_' + currentCollectionId, currentSetId);
          selectedInSetUid = null;
          renderSets();
          renderSongsPanel();
        });
        setsList.appendChild(div);
      });

      refreshPills();
    }

    function renderSongTable(){
      const q = (songSearch.value || '').trim().toLowerCase();
      songTable.innerHTML = '';

      let list = SONGS;
      if (q){
        list = SONGS.filter(s => {
          const title = (s.title || '').toLowerCase();
          const artist = (s.artist || '').toLowerCase();
          const singer = (s.singer || '').toLowerCase();
          return title.includes(q) || artist.includes(q) || singer.includes(q);
        });
      }

      if (!list.length){
        songTable.innerHTML = `<tr><td colspan="4" style="color:var(--muted); padding:12px;">No matches.</td></tr>`;
        return;
      }

      list.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = 'clickable';
        tr.innerHTML = `
          <td><b>${escapeHtml(s.title || '(untitled)')}</b><div class="liSub">${escapeHtml(s.artist || '')}</div></td>
          <td>${escapeHtml(s.singer || '—')}</td>
          <td>${escapeHtml(String(s.duration || '—'))}</td>
          <td>${escapeHtml(String((s.tempo ?? '—')))}</td>
        `;
        tr.addEventListener('click', () => addSongToCurrentSet(String(s.uid)));
        songTable.appendChild(tr);
      });
    }

    function renderInSet(){
      inSetTable.innerHTML = '';
      const col = findCollection(currentCollectionId);
      const set = col ? findSet(col, currentSetId) : null;

      if (!col){
        inSetTable.innerHTML = `<tr><td style="color:var(--muted); padding:12px;">Select a collection.</td></tr>`;
        return;
      }
      if (isSmart(col)){
        inSetTable.innerHTML = `<tr><td style="color:var(--muted); padding:12px;">Smart collection. Nothing to edit.</td></tr>`;
        return;
      }
      if (!set){
        inSetTable.innerHTML = `<tr><td style="color:var(--muted); padding:12px;">Select a set.</td></tr>`;
        return;
      }

      const uids = Array.isArray(set.songs) ? set.songs.map(x => String(x)) : [];
      if (!uids.length){
        inSetTable.innerHTML = `<tr><td style="color:var(--muted); padding:12px;">No songs in this set.</td></tr>`;
        return;
      }

      uids.forEach(uid => {
        const s = SONG_BY_UID.get(uid);
        const title = s ? (s.title || '(untitled)') : 'Missing song';
        const artist = s ? (s.artist || '') : uid;

        const tr = document.createElement('tr');
        tr.className = (uid === selectedInSetUid) ? 'selected clickable' : 'clickable';
        tr.innerHTML = `<td><b>${escapeHtml(title)}</b> <span class="pill" style="margin-left:8px;">${escapeHtml(artist)}</span></td>`;
        tr.addEventListener('click', () => {
          selectedInSetUid = uid;
          renderInSet();
        });
        inSetTable.appendChild(tr);
      });
    }

    function renderSongsPanel(){
      const col = findCollection(currentCollectionId);

      if (col && isSmart(col)){
        smartNote.style.display = '';
        smartName.textContent = col.name || col.id || 'Smart';
      } else {
        smartNote.style.display = 'none';
      }

      renderSongTable();
      renderInSet();
      refreshPills();
    }

    function addSongToCurrentSet(uid){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const set = findSet(col, currentSetId);
      if (!set) return;

      if (!Array.isArray(set.songs)) set.songs = [];
      set.songs.push(uid);

      selectedInSetUid = uid;
      SETLISTS.updated = nowIso();
      renderInSet();
      refreshPills();
    }

    function removeSelectedFromSet(){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const set = findSet(col, currentSetId);
      if (!set || !Array.isArray(set.songs) || !selectedInSetUid) return;

      const i = set.songs.map(String).indexOf(String(selectedInSetUid));
      if (i >= 0) set.songs.splice(i, 1);

      selectedInSetUid = null;
      SETLISTS.updated = nowIso();
      renderInSet();
      refreshPills();
    }

    function moveSelectedInSet(delta){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const set = findSet(col, currentSetId);
      if (!set || !Array.isArray(set.songs) || !selectedInSetUid) return;

      const arr = set.songs.map(String);
      const i = arr.indexOf(String(selectedInSetUid));
      if (i < 0) return;

      const j = Math.min(Math.max(i + delta, 0), arr.length - 1);
      if (j === i) return;

      const moved = set.songs.splice(i, 1)[0];
      set.songs.splice(j, 0, moved);

      SETLISTS.updated = nowIso();
      renderInSet();
      refreshPills();
    }

    function addCollection(){
      const name = prompt('Collection name?');
      if (!name) return;

      const id = slugId(name);
      const exists = !!findCollection(id);
      const finalId = exists ? (id + '_' + Math.random().toString(16).slice(2,6)) : id;

      const col = { id: finalId, type: 'list', name: name, tags: [], sets: [{ id:'main', name:name, songs:[] }] };
      SETLISTS.collections = getCollections().concat([col]);
      SETLISTS.updated = nowIso();

      currentCollectionId = finalId;
      currentSetId = 'main';
      localStorage.setItem('cps_sb_collection', currentCollectionId);
      localStorage.setItem('cps_sb_set_' + currentCollectionId, currentSetId);

      renderCollections();
      renderSets();
      renderSongsPanel();
    }

    function renameCollection(){
      const col = findCollection(currentCollectionId);
      if (!col) return;

      const name = prompt('New collection name?', col.name || col.id || '');
      if (!name) return;

      col.name = name;
      SETLISTS.updated = nowIso();
      renderCollections();
    }

    function deleteCollection(){
      const col = findCollection(currentCollectionId);
      if (!col) return;

      if (!confirm(`Delete collection "${col.name || col.id}"?`)) return;

      SETLISTS.collections = getCollections().filter(c => String(c.id) !== String(currentCollectionId));
      SETLISTS.updated = nowIso();

      currentCollectionId = (getCollections()[0]?.id) ? String(getCollections()[0].id) : null;
      currentSetId = null;

      renderCollections();
      renderSets();
      renderSongsPanel();
    }

    function addSet(){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const name = prompt('Set name?');
      if (!name) return;

      const id = slugId(name);
      if (!Array.isArray(col.sets)) col.sets = [];
      const exists = col.sets.some(s => String(s.id) === String(id));
      const finalId = exists ? (id + '_' + Math.random().toString(16).slice(2,6)) : id;

      col.sets.push({ id: finalId, name: name, songs: [] });
      SETLISTS.updated = nowIso();

      currentSetId = finalId;
      localStorage.setItem('cps_sb_set_' + currentCollectionId, currentSetId);

      renderSets();
      renderSongsPanel();
    }

    function renameSet(){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const set = findSet(col, currentSetId);
      if (!set) return;

      const name = prompt('New set name?', set.name || set.id || '');
      if (!name) return;

      set.name = name;
      SETLISTS.updated = nowIso();
      renderSets();
    }

    function deleteSet(){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const set = findSet(col, currentSetId);
      if (!set) return;

      if (!confirm(`Delete set "${set.name || set.id}"?`)) return;

      col.sets = getSets(col).filter(s => String(s.id) !== String(currentSetId));
      SETLISTS.updated = nowIso();

      currentSetId = (getSets(col)[0]?.id) ? String(getSets(col)[0].id) : null;
      localStorage.setItem('cps_sb_set_' + currentCollectionId, currentSetId || '');

      selectedInSetUid = null;

      renderSets();
      renderSongsPanel();
    }

    function moveSet(delta){
      const col = findCollection(currentCollectionId);
      if (!col || isSmart(col)) return;

      const sets = getSets(col);
      const i = sets.map(s => String(s.id)).indexOf(String(currentSetId));
      if (i < 0) return;

      const j = Math.min(Math.max(i + delta, 0), sets.length - 1);
      if (j === i) return;

      const moved = sets.splice(i, 1)[0];
      sets.splice(j, 0, moved);
      col.sets = sets;

      SETLISTS.updated = nowIso();
      renderSets();
    }

    function downloadSetlists(){
      if (!SETLISTS) return;

      // Preserve version if present
      if (!('version' in SETLISTS)) SETLISTS.version = 1;
      SETLISTS.updated = nowIso();

      const blob = new Blob([JSON.stringify(SETLISTS, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'setlists.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 2000);
    }

    async function loadAll(){
      // Mode indicator
      modePill.textContent = (location.protocol === 'file:') ? 'Mode: file://' : ('Mode: ' + location.protocol);
      setHint('Loading songs + collections…');

      // Load songs library
      LIB = await fetchJSON('../library/library.index.json');
      SONGS = Array.isArray(LIB?.songs) ? LIB.songs : []; // canonical (one per song_uid)
      SONG_BY_UID = new Map();
      SONG_BY_SONG = new Map();
      SONGS.forEach(s => { const k = songKeyFor(s); if (k) SONG_BY_SONG.set(k, s); });
// Load collections (preferred: library/setlists.json)
      try{
        SETLISTS = await fetchJSON('../library/setlists.json');
      }catch(e){
        // fallback: if collections exist inside library.index.json, use them
        const cols = Array.isArray(LIB?.collections) ? LIB.collections : [];
        SETLISTS = { version: 1, updated: nowIso(), collections: cols };
      }

      // Ensure shape
      if (!Array.isArray(SETLISTS.collections)) SETLISTS.collections = [];

      const cSaved = localStorage.getItem('cps_sb_collection');
      const cIds = SETLISTS.collections.map(c => String(c.id));
      currentCollectionId = (cSaved && cIds.includes(cSaved)) ? cSaved : (cIds[0] || null);

      if (currentCollectionId){
        const setSaved = localStorage.getItem('cps_sb_set_' + currentCollectionId) || '';
        const col = findCollection(currentCollectionId);
        const sets = getSets(col);
        const setIds = sets.map(s => String(s.id));
        currentSetId = (setSaved && setIds.includes(setSaved)) ? setSaved : (setIds[0] || null);
      } else {
        currentSetId = null;
      }

      setHint(`Loaded ${SONGS.length} songs and ${SETLISTS.collections.length} collections. Make changes, then Download setlists.json.`);
      renderCollections();
      renderSets();
      renderSongsPanel();
    }

    // Events
    reloadBtn.addEventListener('click', loadAll);
    downloadBtn.addEventListener('click', downloadSetlists);

    // Apps launcher trigger
    const appsBtn = document.getElementById('appsBtn');
    const brandHome = document.getElementById('brandHome');
    if (appsBtn) appsBtn.addEventListener('click', (e) => { e.preventDefault(); openAppsLauncher(); });
    if (brandHome) brandHome.addEventListener('click', (e) => { e.preventDefault(); openAppsLauncher(); });


    collectionFilter.addEventListener('input', renderCollections);
    songSearch.addEventListener('input', renderSongTable);

    addCollectionBtn.addEventListener('click', addCollection);
    renameCollectionBtn.addEventListener('click', renameCollection);
    deleteCollectionBtn.addEventListener('click', deleteCollection);

    addSetBtn.addEventListener('click', addSet);
    renameSetBtn.addEventListener('click', renameSet);
    deleteSetBtn.addEventListener('click', deleteSet);
    setUpBtn.addEventListener('click', () => moveSet(-1));
    setDownBtn.addEventListener('click', () => moveSet(1));

    removeSongBtn.addEventListener('click', removeSelectedFromSet);
    inSetUpBtn.addEventListener('click', () => moveSelectedInSet(-1));
    inSetDownBtn.addEventListener('click', () => moveSelectedInSet(1));

    // Init
    loadAll().catch(err => {
      console.error(err);
      setHint('Failed to load. Check console + paths.');
    });
  </script>

<script>
  if (window.CPSNav && typeof window.CPSNav.init === 'function') {
    window.CPSNav.init({ triggerSelector: '#brandHome' });
  }
</script>

</body>
</html>
