name: Rebuild library index (verify)

on:
  push:
    branches:
      - "**"
  pull_request:

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Rebuild indexes
        run: |
          node tools/rebuild_library_index.js --repo .

      - name: Verify no changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo ""
            echo "❌ Library index is out of date."
            echo "Run this locally, then commit the generated files:"
            echo "  node tools/rebuild_library_index.js --repo ."
            echo ""
            echo "Changed files:"
            git status --porcelain
            echo ""
            echo "Diff (first 200 lines):"
            git diff | sed -n '1,200p'
            exit 1
          fi
          echo "✅ Library index is up to date."
