<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChordPro Studio – Stage Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111111">

  <style>
    :root{
      --ipad-bg:#0f1115;
      --panel:#171a21;
      --card:#1f2430;
      --text:#f5f7ff;
      --muted:#aab2c5;
      --border:rgba(255,255,255,0.10);
      --accent:#6aa3ff;
    }
    body.light{
      --ipad-bg:#f2f3f6;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#121418;
      --muted:#5c6472;
      --border:rgba(0,0,0,0.12);
      --accent:#2a66ff;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--ipad-bg);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:10px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .brand{
      font-weight:700;
      letter-spacing:0.2px;
      margin-right:auto;
    }

    select, button{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      outline:none;
    }
    button{
      cursor:pointer;
    }
    button:hover{
      border-color:rgba(255,255,255,0.22);
    }
    body.light button:hover{
      border-color:rgba(0,0,0,0.22);
    }

    main{
      padding:14px;
      max-width:1100px;
      margin:0 auto;
      box-sizing:border-box;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:12px;
    }

    .status{
      font-size:13px;
      color:var(--muted);
    }

    .cards{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:12px 0;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      min-width:220px;
    }
    .card h3{
      margin:0 0 4px 0;
      font-size:14px;
    }
    .card .small{
      font-size:12px;
      color:var(--muted);
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
    }
    th, td{
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:14px;
      vertical-align:top;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      background:rgba(255,255,255,0.02);
    }
    body.light th{
      background:rgba(0,0,0,0.03);
    }
    tr:last-child td{
      border-bottom:none;
    }

    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      margin-left:6px;
    }

    .linklike{
      color:var(--accent);
      cursor:pointer;
      text-decoration:none;
    }
    .linklike:hover{
      text-decoration:underline;
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">Stage Viewer</div>

    <label>
      Setlist:
      <select id="setlistSelect" disabled>
        <option>Loading…</option>
      </select>
    </label>

    <label>
      Persona:
      <select id="personaSelect" disabled>
        <option>Loading…</option>
      </select>
    </label>

    <button id="refreshBtn" title="Reload library index">Refresh</button>
    <button id="themeBtn" title="Toggle light/dark">Toggle Theme</button>
  </header>

  <main>
    <div class="row">
      <div class="status" id="status">Loading library…</div>
    </div>

    <div class="cards" id="summaryCards" style="display:none;"></div>

    <div id="tableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th style="width:42%;">Song</th>
            <th style="width:22%;">Singer</th>
            <th style="width:18%;">Duration</th>
            <th style="width:18%;">Tempo</th>
          </tr>
        </thead>
        <tbody id="songRows"></tbody>
      </table>
    </div>
  </main>

  <script>
    // --- PWA SW ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./serviceWorker.js').catch(() => {});
    }

    // --- Theme ---
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('cps_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });
    (function initTheme(){
      const t = localStorage.getItem('cps_theme');
      if (t === 'light') document.body.classList.add('light');
    })();

    // --- State ---
    const statusEl = document.getElementById('status');
    const setlistSelect = document.getElementById('setlistSelect');
    const personaSelect = document.getElementById('personaSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const songRows = document.getElementById('songRows');
    const tableWrap = document.getElementById('tableWrap');
    const summaryCards = document.getElementById('summaryCards');

    let LIB = null;          // library.index.json
    let SONG_MAP = new Map(); // uid -> song record
    let CURRENT_SETLIST_ID = null;

    function setStatus(msg){
      statusEl.textContent = msg;
    }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }

    function unique(arr){
      return Array.from(new Set(arr)).filter(Boolean);
    }

    function buildSongMap(){
      SONG_MAP = new Map();
      (LIB.songs || []).forEach(s => {
        if (s && s.uid) SONG_MAP.set(String(s.uid), s);
      });
    }

    function computePersonas(){
      // Collect from song.personas OR song.files keys (excluding _default)
      const p = [];
      (LIB.songs || []).forEach(s => {
        if (Array.isArray(s.personas)) p.push(...s.personas);
        if (s.files && typeof s.files === 'object') {
          Object.keys(s.files).forEach(k => { if (k && k !== '_default') p.push(k); });
        }
      });
      return unique(p).sort((a,b)=>a.localeCompare(b));
    }

    function renderSummary(){
      const songCount = (LIB.songs || []).length;
      const setlistCount = (LIB.setlists || []).length;

      const personas = computePersonas();
      const personaText = personas.length ? personas.join(', ') : '—';

      summaryCards.innerHTML = `
        <div class="card">
          <h3>Library</h3>
          <div class="small">Songs: <b>${songCount}</b></div>
          <div class="small">Setlists: <b>${setlistCount}</b></div>
          <div class="small">Last consolidated:</div>
          <div class="small"><b>${LIB.lastConsolidated || '—'}</b></div>
        </div>
        <div class="card">
          <h3>Personas</h3>
          <div class="small"><b>${personaText}</b></div>
        </div>
      `;
      summaryCards.style.display = 'flex';
    }

    function populatePersonaSelect(){
      const personas = computePersonas();
      personaSelect.innerHTML = '';
      if (!personas.length){
        personaSelect.innerHTML = '<option value="">(none)</option>';
        personaSelect.disabled = true;
        return;
      }
      personas.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        personaSelect.appendChild(opt);
      });

      // restore previous choice if possible
      const saved = localStorage.getItem('cps_persona');
      if (saved && personas.includes(saved)) personaSelect.value = saved;

      personaSelect.disabled = false;
    }

    function populateSetlistSelect(){
      setlistSelect.innerHTML = '';
      const setlists = Array.isArray(LIB.setlists) ? LIB.setlists : [];
      if (!setlists.length){
        setlistSelect.innerHTML = '<option value="">(no setlists)</option>';
        setlistSelect.disabled = true;
        return;
      }

      setlists.forEach(sl => {
        const opt = document.createElement('option');
        opt.value = sl.id || sl.name || '';
        opt.textContent = sl.name || sl.id || '(unnamed)';
        setlistSelect.appendChild(opt);
      });

      // pick last used if exists
      const saved = localStorage.getItem('cps_setlist');
      const values = setlists.map(sl => String(sl.id || sl.name || ''));
      const pick = (saved && values.includes(saved)) ? saved : values[0];

      setlistSelect.value = pick;
      CURRENT_SETLIST_ID = pick;
      setlistSelect.disabled = false;
    }

    function findSetlistById(id){
      const setlists = Array.isArray(LIB.setlists) ? LIB.setlists : [];
      return setlists.find(sl => String(sl.id || sl.name || '') === String(id));
    }

    function getSetlistSongUids(setlist){
      const uids = [];
      const sets = Array.isArray(setlist?.sets) ? setlist.sets : [];
      sets.forEach(s => {
        const arr = Array.isArray(s.songs) ? s.songs : [];
        arr.forEach(uid => uids.push(String(uid)));
      });
      return uids;
    }

    function renderSetlist(){
      const setlist = findSetlistById(CURRENT_SETLIST_ID);
      if (!setlist){
        setStatus('No setlist selected.');
        songRows.innerHTML = '';
        tableWrap.style.display = 'none';
        return;
      }

      const uids = getSetlistSongUids(setlist);

      // Render rows
      songRows.innerHTML = '';
      let missing = 0;

      uids.forEach(uid => {
        const s = SONG_MAP.get(uid);
        if (!s){
          missing++;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><b>Missing song</b> <span class="pill">${uid}</span></td>
            <td>—</td><td>—</td><td>—</td>
          `;
          songRows.appendChild(tr);
          return;
        }

        const title = s.title || '(untitled)';
        const artist = s.artist || '(unknown)';
        const singer = s.singer || '—';
        const duration = s.duration || '—';
        const tempo = (s.tempo !== null && s.tempo !== undefined && s.tempo !== "") ? s.tempo : '—';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${escapeHtml(title)}</b> <span class="pill">${escapeHtml(artist)}</span></td>
          <td>${escapeHtml(singer)}</td>
          <td>${escapeHtml(String(duration))}</td>
          <td>${escapeHtml(String(tempo))}</td>
        `;
        songRows.appendChild(tr);
      });

      tableWrap.style.display = 'block';

      const persona = personaSelect.value || '(none)';
      const msg = `Loaded setlist: ${setlist.name || setlist.id} • Songs: ${uids.length}` + (missing ? ` • Missing: ${missing}` : '') + ` • Persona: ${persona}`;
      setStatus(msg);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    async function loadLibrary(){
      setStatus('Loading library index…');
      setlistSelect.disabled = true;
      personaSelect.disabled = true;
      tableWrap.style.display = 'none';
      summaryCards.style.display = 'none';

      // Stage Viewer is in /apps, so library is ../library/...
      const url = '../library/library.index.json';

      try{
        LIB = await fetchJSON(url);
        buildSongMap();
        renderSummary();
        populatePersonaSelect();
        populateSetlistSelect();
        renderSetlist();
      }catch(e){
        console.error(e);
        setStatus(`Failed to load library: ${e.message}`);
      }
    }

    // Events
    refreshBtn.addEventListener('click', loadLibrary);

    setlistSelect.addEventListener('change', () => {
      CURRENT_SETLIST_ID = setlistSelect.value;
      localStorage.setItem('cps_setlist', CURRENT_SETLIST_ID);
      renderSetlist();
    });

    personaSelect.addEventListener('change', () => {
      localStorage.setItem('cps_persona', personaSelect.value);
      renderSetlist();
    });

    // Init
    loadLibrary();
  </script>
</body>
</html>
