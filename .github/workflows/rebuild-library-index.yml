name: Rebuild library index (verify)

on:
  # Verify on PRs and on non-main branches.
  # main branch is handled by the auto-rebuild workflow that commits regenerated indexes.
  pull_request:
  push:
    branches-ignore:
      - main

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Rebuild indexes
        run: |
          python3 -u consolidate_library_songuid_schema_compatible.py

      - name: Verify no changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo ""
            echo "❌ Library index is out of date."
            echo "Run this locally, then commit the generated files:"
            echo "  python3 -u consolidate_library_songuid_schema_compatible.py"
            echo ""
            echo "Changed files:"
            git status --porcelain
            echo ""
            echo "Diff (first 200 lines):"
            git diff | sed -n '1,200p'
            exit 1
          fi
          echo "✅ Library index is up to date."
