<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">ChordPro Edit v2.7.5</title>
  <style>
/* =========================
   GLOBAL THEME BLOCK (Shared)
   ========================= */
:root{
  --bg:#0b0f14;
  --panel:#0f1620;
  --panel2:#0c121b;
  --text:#e8eef7;
  --muted:#9fb0c7;
  --line:#223144;
  --accent:#00bcd4;
  --accent2:#3b82f6;
  --danger:#e11d48;
  --ok:#22c55e;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 12px;
  --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

  /* Preview/export theme vars */
  --bg-dark:#000000; --sec-dark:#ffff00; --cho-dark:#00ffff; --chorus-dark:#ff6b6b;
  --bg-light:#ffffff; --sec-light:#d00000; --cho-light:#0056b3; --chorus-light:#d00000;

  --ipad-bg: var(--bg-dark);
  --section-clr: var(--sec-dark);
  --chord-clr: var(--cho-dark);
  --chorus-clr: var(--chorus-dark);
  --lyric-clr:#ffffff;
  --font-size:16px;
  --line-height:1.4;

  --a4-width: 820px;
  --btn-grey: #1b2a3d;
  --btn-accent: var(--accent);
  --page-height: 1050px;

  /* ‚úÖ Shared per-device preview font (matches viewer key cps_font) */
  --song-font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:var(--sans);
  background:linear-gradient(180deg, #07101a 0%, #05070b 100%);
  color:var(--text);
  height: 100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

a{ color: var(--accent2); }
button, select, input, textarea{ font-family:inherit; }

/* ‚úÖ Font presets (same class names as viewer) */
body.font-mono { --song-font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
body.font-system { --song-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body.font-readable { --song-font: ui-rounded, "SF Pro Rounded", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body.font-serif { --song-font: Georgia, "Times New Roman", Times, serif; }

body.light-theme{
  --lyric-clr:#000000;
  --text:#222222;
  --muted:#6b7280;
  --line:#e5e7eb;
  --btn-grey:#e5e7eb;
  background:#f0f2f5;
}

/* THE FIXED PHYSICAL CUTOFF */
.static-page-marker {
  position: absolute;
  top: var(--page-height);
  left: 0;
  width: 100%;
  border-top: 3px dashed #ff0000;
  z-index: 100;
  pointer-events: none;
}
.static-page-marker::after {
  content: "PAGE 1 PHYSICAL CUTOFF";
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: -12px;
  font-size: 12px;
  font-weight: bold;
  color: #ff0000;
  background: var(--ipad-bg);
  padding: 0 15px;
}

/* Header */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-bottom:1px solid var(--line);
  background: rgba(10,16,24,.9);
  backdrop-filter: blur(8px);
  margin-bottom:12px;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
  letter-spacing:.2px;
  user-select:none;
}
.brand .dot{
  width:10px;height:10px;border-radius:99px;
  background: var(--accent);
  box-shadow: 0 0 18px rgba(0,188,212,.6);
}
.btn-group{
  display:flex;
  gap:8px;
  row-gap:8px;
  align-items:center;
  flex-wrap:wrap;          /* ‚úÖ wrap buttons, not text */
  justify-content:flex-end;
}

/* Selects */
.theme-select, .header-select{
  appearance:none;
  border:1px solid #2a3a50;
  background: linear-gradient(180deg, #1b2a3d 0%, #152234 100%);
  color: var(--text);
  padding: 9px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  font-size:13px;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
  height:36px;
}
.theme-select{ width:100%; }
.header-select{ min-width:140px; }

body.light-theme .header-select{
  border:1px solid #d1d5db;
  background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
  color:#1f2937;
  box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

/* Buttons */
button{
  white-space:nowrap;
  display:inline-flex;
  align-items:center;
  gap:8px;
  appearance:none;
  border:1px solid #2a3a50;
  background: linear-gradient(180deg, #1b2a3d 0%, #152234 100%);
  color: var(--text);
  padding: 9px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  font-size:13px;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
  user-select:none;
  min-width:100px;
  height:36px;
  justify-content:center;
  box-sizing:border-box;
}
button:hover{ filter:brightness(1.08); }
button:active{ transform: translateY(1px); }
button.primary{
  border-color: rgba(0,188,212,.45);
  background: linear-gradient(180deg, rgba(0,188,212,.28) 0%, rgba(0,188,212,.18) 100%);
}
button.danger{
  border-color: rgba(225,29,72,.4);
  background: linear-gradient(180deg, rgba(225,29,72,.22) 0%, rgba(225,29,72,.14) 100%);
}
body.light-theme button{
  border:1px solid #d1d5db;
  background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
  color:#1f2937;
  box-shadow: 0 2px 4px rgba(0,0,0,.1);
}
#saveBackBtn, #newVersionBtn{ min-width:160px; }

/* Meta */
/* =====================
   Song Info (collapsible)
   ===================== */
.meta-card{
  margin: 0 12px 12px 12px;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  background: rgba(15,22,32,.88);
  box-shadow: var(--shadow);
  overflow: hidden;
}
body.light-theme .meta-card{
  background:#ffffff;
  border-color:#e5e7eb;
}
.meta-card > summary{
  list-style:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 10px 12px;
  cursor:pointer;
  user-select:none;
}
.meta-card > summary::-webkit-details-marker{ display:none; }
.meta-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight: 800;
}
.meta-title .chev{
  width: 10px;
  opacity: .8;
  transform: rotate(0deg);
  transition: transform 140ms ease;
}
details[open].meta-card > summary .chev{ transform: rotate(90deg); }

.meta-pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.25);
  color: rgba(232,238,247,0.92);
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: min(70vw, 820px);
}
body.light-theme .meta-pill{
  background: rgba(0,0,0,0.04);
  border-color: rgba(0,0,0,0.12);
  color:#111827;
}

.meta-body{
  padding: 12px;
  border-top: 1px solid rgba(255,255,255,0.08);
}
body.light-theme .meta-body{
  border-top-color: #e5e7eb;
}

/* Two-column labelled grid (more readable than one long row) */
.meta-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(160px, 1fr));
  gap: 10px;
  align-items:end;
}
@media (max-width: 1100px){
  .meta-grid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
}
@media (max-width: 640px){
  .meta-grid{ grid-template-columns: 1fr; }
}

.meta-field label{
  display:block;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .2px;
  color: rgba(232,238,247,0.92);
  margin: 0 0 5px 2px;
}
body.light-theme .meta-field label{
  color:#374151;
}

.meta-field input,
.meta-field select{
  width: 100%;
  height: 36px;
  border-radius: 10px;
  padding: 9px 10px;
  border: 1px solid var(--line);
  background: rgba(4,8,12,.55);
  color: var(--editor-text);
  outline: none;
}
.meta-field input:focus,
.meta-field select:focus{
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(0,188,212,.12);
}
body.light-theme .meta-field input,
body.light-theme .meta-field select{
  background:#f9fafb;
  border-color:#d1d5db;
  color:#111827;
}

.meta-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin-top: 10px;
}
.meta-actions .left,
.meta-actions .right{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* Small toggle button */
.meta-toggle{
  min-width: unset;
  height: 32px;
  padding: 0 10px;
  font-size: 12px;
  border-radius: 10px;
}


/* Layout */
.main-layout{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  flex-grow:1;
  min-height:0;
  padding: 0 12px 12px 12px;
}
.editor-container{
  display:flex;
  flex-direction:column;
  background: rgba(15,22,32,.88);
  border:1px solid var(--line);
  padding:15px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
body.light-theme .editor-container{ background:#fff; border-color:#e5e7eb; }

.styling-controls{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
  margin-bottom:10px;
  padding:12px;
  border:1px solid var(--line);
  border-radius:10px;
  background: rgba(12,18,27,.5);
}
.slider-group{
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:10px;
  font-weight:bold;
}
.slider-group input[type="range"]{ accent-color: var(--accent); }
.val-badge{
  background: rgba(0,188,212,.18);
  color: var(--accent);
  padding: 2px 5px;
  border-radius:6px;
  font-size:10px;
  text-align:center;
  border: 1px solid rgba(0,188,212,.3);
  font-weight:700;
}

textarea{
  flex-grow:1;
  background: rgba(4,8,12,.55);
  color: var(--text);
  border: 1px solid var(--line);
  padding: 15px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-size:14px;
  line-height:1.5;
  resize:none;
  margin-top:10px;
  outline:none;
  border-radius:10px;
}
textarea:focus{
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(0,188,212,.12);
}
body.light-theme textarea{ background:#f9fafb; border-color:#d1d5db; color:#222; }

.preview-pane{
  background: var(--ipad-bg);
  border:8px solid #000;
  border-radius: var(--radius);
  overflow-y:auto;
  width:100%;
  max-width: var(--a4-width);
  margin:0 auto;
  position:relative;
  box-shadow: var(--shadow);
}
.preview-content{
  padding:50px;
  color: var(--lyric-clr);
  white-space: pre-wrap;
  line-height: var(--line-height);
  font-size: var(--font-size);
  position:relative;
  min-height:1500px;
  font-family: var(--song-font);
}

.p-section{ color: var(--section-clr) !important; font-weight:bold; display:block; margin-top:1.2em; width:fit-content; padding-right:40px; }
.p-chord{ color: var(--chord-clr) !important; font-weight:bold; }
.p-chorus-text{ color: var(--chorus-clr) !important; }
.capo-badge{ font-size:.7em; background: rgba(128,128,128,0.2); padding:2px 8px; border-radius:4px; margin-left:10px; vertical-align:middle; }

/* Page Break Styling */
.page-break{
  page-break-after:always;
  break-after:page;
  display:block;
  height:2px;
  background: repeating-linear-gradient(
    90deg,
    var(--section-clr),
    var(--section-clr) 10px,
    transparent 10px,
    transparent 20px
  );
  margin: 20px 0;
  position: relative;
}
.page-break::after{
  content:"PAGE BREAK";
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%);
  background: var(--ipad-bg);
  padding: 0 10px;
  font-size:10px;
  font-weight:bold;
  color: var(--section-clr);
  letter-spacing:1px;
}

@page{ size:A4; margin:0; }
@media print{
  *{ -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  html, body{ margin:0 !important; padding:0 !important; background: var(--ipad-bg) !important; }
  .header, .meta-section, .editor-container, .static-page-marker{ display:none !important; }
  .main-layout{ display:block !important; }
  .preview-pane{
    border:none !important;
    border-radius:0 !important;
    max-width:100% !important;
    width:100% !important;
    min-height:297mm !important;
    overflow:visible !important;
    height:auto !important;
    background: var(--ipad-bg) !important;
  }
  .preview-content{
    width: var(--a4-width) !important;
    min-height:297mm !important;
    box-sizing:border-box !important;
    margin:0 auto !important;
    padding:50px !important;
    background: var(--ipad-bg) !important;
    color: var(--lyric-clr) !important;
    font-family: var(--song-font) !important;
  }
  .p-chord{ color: var(--chord-clr) !important; }
  .p-section{ color: var(--section-clr) !important; }
  .p-chorus-text{ color: var(--chorus-clr) !important; }
  .page-break{
    page-break-after: always !important;
    break-after: page !important;
    display:block !important;
    height:0 !important;
    background:none !important;
    margin:0 !important;
  }
  .page-break::after{ content:"" !important; display:none !important; }
}

/* Modals / toast / banner */
#textToChoModal, #newVersionModal{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.72);
  z-index:9999;
}
#textToChoModal .t2c-box, #newVersionModal .nv-box{
  width: min(920px, 92vw);
  max-height:90vh;
  overflow:hidden;
  background:#1e1e1e;
  border:1px solid #444;
  border-radius:10px;
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
  color:#eee;
  display:flex;
  flex-direction:column;
}
#newVersionModal .nv-box{ width: min(720px, 92vw); }

#textToChoModal .t2c-head, #newVersionModal .nv-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid #333;
  font-weight:800;
}
#textToChoModal .t2c-body, #newVersionModal .nv-body{
  padding:14px;
  overflow:auto;
  display:grid;
  gap:10px;
}
#textToChoModal input, #textToChoModal textarea, #newVersionModal input{
  width:100%;
  box-sizing:border-box;
  background:#111;
  color:#eee;
  border:1px solid #444;
  border-radius:8px;
  padding:10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
}
#textToChoModal textarea{ min-height:260px; resize:vertical; }
#textToChoModal .t2c-actions, #newVersionModal .nv-actions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  padding-top:6px;
}

#snToast{
  position:fixed;
  right:18px; bottom:18px;
  background: rgba(20,20,20,0.95);
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  font-size:13px;
  opacity:0;
  transform: translateY(8px);
  transition: opacity 160ms ease, transform 160ms ease;
  z-index:10000;
  pointer-events:none;
  max-width: min(520px, 90vw);
}
#snToast.show{ opacity:1; transform: translateY(0); }

#saveAsBanner{
  margin:10px 0 0 0;
  padding:10px 12px;
  border-radius:10px;
  background: rgba(255,196,0,0.14);
  border:1px solid rgba(255,196,0,0.35);
  color: var(--text);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  font-size:13px;
}
#saveAsBanner button{
  background: transparent;
  border:1px solid rgba(255,255,255,0.25);
  color: inherit;
  border-radius:10px;
  padding:4px 10px;
  cursor:pointer;
  min-width: unset;
  height:28px;
}
body.light-theme #saveAsBanner button{ border-color: rgba(0,0,0,0.25); }

.app-footer{
  position:fixed;
  left:10px; bottom:8px;
  z-index:9999;
  font-size:11px;
  color: rgba(255,255,255,0.65);
  background: rgba(0,0,0,0.35);
  border:1px solid rgba(255,255,255,0.12);
  padding:4px 8px;
  border-radius:999px;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  user-select:none;
  pointer-events:none;
  max-width: calc(100% - 20px);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
  </style>
</head>
<body>

<div class="header">
  <div class="brand">
    <div class="dot"></div>
    <span>ChordPro Edit v2.7.5</span>
  </div>
  <div class="btn-group">
    <a href="./index.html" style="text-decoration:none">
      <button title="Apps">Apps</button>
    </a>

    <select id="fontSelect" class="header-select" title="Preview font">
      <option value="mono">Mono</option>
      <option value="system">System</option>
      <option value="readable">Readable</option>
      <option value="serif">Serif</option>
    </select>

    <button id="themeToggleBtn" onclick="toggleTheme()">üåô Theme</button>
    <button onclick="newSong()">üìÑ New</button>
    <button onclick="clearAllFields()" class="danger">üóëÔ∏è Clear</button>
    <button onclick="insertPageBreak()">‚úÇÔ∏è Break</button>
    <button onclick="insertBlankLine()">‚ûï Blank Line</button>
    <button onclick="openChoFile()">üìÇ Open</button>
    <button id="btnTextToCho" title="Convert plain text to ChordPro">üß© Text ‚Üí .cho</button>
    <button onclick="exportPdf()">üìÑ PDF</button>
    <button onclick="downloadCho()" class="primary" style="background:var(--btn-accent);" title="Save .cho (downloads). After New version, this prompts Save As.">üíæ Save .cho</button>
    <button id="saveBackBtn" onclick="saveBackToFile()" style="display:none; background: var(--btn-accent);" title="Overwrite the currently opened file (Chrome/Edge only)">üíæ Save back to file</button>
    <button id="newVersionBtn" onclick="nvShow()" title="Create a new version (new UID). Requires Save .cho to save a new file.">üß¨ New version</button>
    <input type="file" id="fileInput" style="display:none">
  </div>
</div>

<div id="saveAsBanner" style="display:none;">
  üß¨ New version created ‚Äî click <b>üíæ Save .cho</b> to save a new file.
  <button type="button" id="saveAsBannerHideBtn" title="Hide this message">‚úï</button>
</div>

<details class="meta-card" id="metaDetails" open>
  <summary>
    <div class="meta-title">
      <span class="chev">‚ñ∂</span>
      <span>Song Info</span>
    </div>
    <div id="metaSummary" class="meta-pill">‚Äî</div>
  </summary>

  <div class="meta-body">
    <div class="meta-grid">
      <div class="meta-field">
        <label for="mTitle">Title</label>
        <input type="text" id="mTitle" placeholder="Title" oninput="updatePageTitle(); onMetaChanged()">
      </div>

      <div class="meta-field">
        <label for="mArtist">Artist</label>
        <input type="text" id="mArtist" placeholder="Artist" oninput="updatePageTitle(); onMetaChanged()">
      </div>

      <div class="meta-field">
        <label for="mSinger">Singer</label>
        <select id="mSinger" onchange="onMetaChanged()">
          <option value="Adam">Adam</option>
          <option value="Pete">Pete</option>
          <option value="Both">Both</option>
        </select>
      </div>

      <div class="meta-field">
        <label for="mPersona">Version</label>
        <select id="mPersona" onchange="onMetaChanged()">
          <option value="Adam">Adam</option>
          <option value="Pete">Pete</option>
        </select>
      </div>

      <div class="meta-field">
        <label for="mKey">Key</label>
        <input type="text" id="mKey" placeholder="Key" oninput="onMetaChanged()">
      </div>

      <div class="meta-field">
        <label for="mCapo">Capo</label>
        <input type="text" id="mCapo" placeholder="Capo" oninput="onMetaChanged()">
      </div>

      <div class="meta-field">
        <label for="mTempo">BPM</label>
        <input type="text" id="mTempo" placeholder="BPM" oninput="onMetaChanged()">
      </div>

      <div class="meta-field">
        <label for="mDur">Duration</label>
        <input type="text" id="mDur" placeholder="m:ss" oninput="onMetaChanged()">
      </div>
    </div>

    <div class="meta-actions">
      <div class="left">
        <button type="button" class="meta-toggle" id="toggleTagsBtn" title="Hide or show the meta tag lines in the editor textarea">üè∑Ô∏è Tags: Hidden</button>
      </div>

      <div class="right">
        <div style="display:flex; gap:5px;">
          <button type="button" onclick="transpose(-1)" style="min-width:48px;">‚ô≠</button>
          <button type="button" onclick="transpose(1)" style="min-width:48px;">‚ôØ</button>
        </div>
      </div>
    </div>
  </div>
</details>

</div>

<div class="main-layout">
  <div class="editor-container">
    <div style="font-size: 11px; font-weight: bold; margin-bottom: 5px;">THEME FOR PREVIEW AND EXPORT TO PDF:</div>
    <div class="styling-controls">
      <div class="slider-group">STYLE PROFILE:
        <select id="userTheme" class="theme-select" onchange="loadThemeSettings()">
          <option value="Adam">Adam</option>
          <option value="Pete">Pete</option>
        </select>
      </div>
      <div class="slider-group">BG <input type="color" id="bgColor" oninput="updateUI()"></div>
      <div class="slider-group">CHORD <input type="color" id="choColor" oninput="updateUI()"></div>
      <div class="slider-group">SECTION <input type="color" id="secColor" oninput="updateUI()"></div>
      <div class="slider-group">CHORUS <input type="color" id="chorusColor" oninput="updateUI()"></div>
      <div class="slider-group">SIZE <input type="range" id="fontSize" min="12" max="50" value="18" oninput="updateUI()"><span class="val-badge" id="v-size">18px</span></div>
      <div class="slider-group">LINE <input type="range" id="lineSpacing" min="1.0" max="3.0" step="0.1" value="1.4" oninput="updateUI()"><span class="val-badge" id="v-line">1.4</span></div>
      <button onclick="resetSliders()" style="min-width:unset; width:100%; font-size:9px; height:24px; align-self:end;">‚ôªÔ∏è Reset</button>
    </div>
    <textarea id="editor" oninput="saveAndRender()" placeholder="Paste ChordPro here..."></textarea>
  </div>

  <div class="preview-pane">
    <div class="static-page-marker"></div>
    <div id="preview" class="preview-content"></div>
  </div>
</div>

<!-- Text ‚Üí ChordPro Modal -->
<div id="textToChoModal" aria-hidden="true">
  <div class="t2c-box" role="dialog" aria-modal="true" aria-label="Text to ChordPro Converter">
    <div class="t2c-head">
      <div>üß© Text ‚Üí .cho Converter</div>
      <button type="button" id="t2cCloseBtn" title="Close">Close</button>
    </div>
    <div class="t2c-body">
      <div style="display:grid; gap:6px;">
        <label style="opacity:.85; font-size:12px; font-weight:bold;">Optional filename (used to infer Title / Artist / Version)</label>
        <input id="t2cFilename" placeholder="e.g. 3 A.M. - Matchbox Twenty (Adam)">
        <div style="opacity:.7; font-size:12px;">If you use ‚ÄúTitle - Artist (Version)‚Äù, tags will be auto-filled.</div>
      </div>

      <div style="display:grid; gap:6px;">
        <label style="opacity:.85; font-size:12px; font-weight:bold;">Paste plain text (lyrics + chords)</label>
        <textarea id="t2cInput" placeholder="Paste text here...&#10;&#10;Example:&#10;Verse 1&#10;D   C   G  Cadd9&#10;she says it's cold outside..."></textarea>
        <div style="opacity:.7; font-size:12px;">
          Converts section headers (Verse/Chorus/Bridge/etc) to <b>{comment: ...}</b> and wraps detected chords like <b>[D]</b>.
          Bulk .docx conversion is still best done via your Automator script.
        </div>
      </div>

      <div class="t2c-actions">
        <button type="button" id="t2cCancelBtn">Cancel</button>
        <button type="button" id="t2cConvertBtn" style="background: var(--btn-accent);">Convert & Load</button>
      </div>
    </div>
  </div>
</div>

<script>
const APP_NAME = 'ChordPro Edit';
const APP_VERSION = 'Build 2026-02-08';

const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const DEFAULTS = {
  dark:  { bg:'#000000', cho:'#00ffff', sec:'#ffff00', chorus:'#ff6b6b', size:18, line:1.4 },
  light: { bg:'#ffffff', cho:'#0056b3', sec:'#d00000', chorus:'#d00000', size:18, line:1.4 }
};

// ‚úÖ Per-device preview font (shared with viewer)
function applyFontChoice(choice){
  document.body.classList.remove('font-mono','font-system','font-readable','font-serif');
  const c = (choice || 'mono');
  document.body.classList.add(`font-${c}`);
  localStorage.setItem('cps_font', c);
}
function initFontSelect(){
  const fontSelect = document.getElementById('fontSelect');
  const saved = localStorage.getItem('cps_font') || 'mono';
  if (fontSelect) fontSelect.value = saved;
  applyFontChoice(saved);
  if (fontSelect){
    fontSelect.addEventListener('change', () => applyFontChoice(fontSelect.value));
  }
}

const META_IDS = ['mTitle','mArtist','mSinger','mKey','mCapo','mTempo','mDur','mPersona'];

// -------------------------------
// Editor content mode: hide/show meta tag lines inside the textarea
// (Meta fields are always the source of truth)
// -------------------------------
let __hideTagsInEditor = (localStorage.getItem('cpe_hide_tags') ?? 'true') === 'true';
let __rawEditorText = ''; // always includes tags

function __stripMetaBlock(text){
    const lines = String(text || '').split(/\r?\n/);
    const known = /^(\{\s*(uid|title|t|artist|a|singer|persona|version|key|k|capo|ca|tempo|bpm|duration)\s*:)/i;
    let i = 0;
    // skip initial blank/comment lines
    while (i < lines.length && (lines[i].trim()==='' || lines[i].trim().startsWith('#'))) i++;
    // strip contiguous tag lines at the top (and blank lines between them)
    let j = i;
    while (j < lines.length){
        const t = lines[j].trim();
        if (t === '') { j++; continue; }
        if (known.test(t)) { j++; continue; }
        break;
    }
    return lines.slice(0, i).concat(lines.slice(j)).join('\n');
}

function __getUidFromText(text){
    const m = String(text || '').match(/\{uid:\s*([^}]+)\}/i);
    return m ? String(m[1]).trim() : '';
}

function __buildMetaBlock(uid){
    const title  = (document.getElementById('mTitle')?.value || '').trim();
    const artist = (document.getElementById('mArtist')?.value || '').trim();
    const singer = (document.getElementById('mSinger')?.value || '').trim();
    const ver    = (document.getElementById('mPersona')?.value || '').trim();
    const key    = (document.getElementById('mKey')?.value || '').trim();
    const capo   = (document.getElementById('mCapo')?.value || '').trim();
    const tempo  = (document.getElementById('mTempo')?.value || '').trim();
    const dur    = (document.getElementById('mDur')?.value || '').trim();

    const out = [];
    out.push(`{uid: ${uid || generateUid()}}`);
    if (ver)   out.push(`{version: ${ver}}`);
    if (title) out.push(`{title: ${title}}`);
    if (artist)out.push(`{artist: ${artist}}`);
    if (singer)out.push(`{singer: ${singer}}`);
    if (key)   out.push(`{key: ${key}}`);
    if (capo)  out.push(`{capo: ${capo}}`);
    if (tempo) out.push(`{tempo: ${tempo}}`);
    if (dur)   out.push(`{duration: ${dur}}`);
    out.push('');
    return out.join('\n');
}

function __composeRawFromBody(bodyText){
    const currentUid = __getUidFromText(__rawEditorText) || __getUidFromText(bodyText) || '';
    const meta = __buildMetaBlock(currentUid);
    const body = String(bodyText || '').replace(/^\s+/, ''); // trim leading whitespace/newlines
    return meta + body;
}

function __setEditorFromRaw(rawText){
    __rawEditorText = String(rawText || '');
    const ed = document.getElementById('editor');
    if (!ed) return;
    ed.value = __hideTagsInEditor ? __stripMetaBlock(__rawEditorText) : __rawEditorText;
}

function __getRawEditorText(){
    const ed = document.getElementById('editor');
    const display = ed ? ed.value : '';
    return __hideTagsInEditor ? __composeRawFromBody(display) : display;
}

function __applyHideTagsUI(){
    const btn = document.getElementById('toggleTagsBtn');
    if (btn) btn.textContent = __hideTagsInEditor ? 'üè∑Ô∏è Tags: Hidden' : 'üè∑Ô∏è Tags: Shown';
}

function toggleTagsInEditor(){
    __hideTagsInEditor = !__hideTagsInEditor;
    localStorage.setItem('cpe_hide_tags', __hideTagsInEditor ? 'true' : 'false');
    __applyHideTagsUI();
    __setEditorFromRaw(__getRawEditorText()); // re-render textarea based on current state
    render();
}


// -------------------------------
// Meta parsing helper
// - Standardise on {version: ...}
// - Still reads legacy {persona: ...}
// -------------------------------
function populateMetaFromChordProText(content){
  META_IDS.forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });

  const tags = {
    mTitle:  /\{t(?:itle)?:\s*(.*?)\}/i,
    mArtist: /\{(?:artist|a):\s*(.*?)\}/i,
    mSinger: /\{singer:\s*(.*?)\}/i,
    // Prefer version tag, fall back to persona
    mPersona:/\{version:\s*(.*?)\}/i,
    mPersonaLegacy:/\{persona:\s*(.*?)\}/i,
    mKey:    /\{k(?:ey)?:\s*(.*?)\}/i,
    mCapo:   /\{ca(?:po)?:\s*(.*?)\}/i,
    mTempo:  /\{(?:tempo|bpm):\s*(.*?)\}/i,
    mDur:    /\{duration:\s*(.*?)\}/i
  };

  for (let id in tags) {
    if (id === 'mPersonaLegacy') continue;
    const match = content.match(tags[id]);
    const el = document.getElementById(id);
    if (match && el) el.value = match[1].trim();
  }

  // Legacy persona ‚Üí persona dropdown if version missing
  const personaEl = document.getElementById('mPersona');
  if (personaEl && (!personaEl.value || !personaEl.value.trim())){
    const oldV = (content.match(tags.mPersonaLegacy) || [null,''])[1];
    if (oldV) personaEl.value = String(oldV).trim();
  }

function __fmt(v){
    const s = String(v || '').trim();
    return s ? s : '‚Äî';
}
function updateMetaSummaryUI(){
    const title = __fmt(document.getElementById('mTitle')?.value);
    const artist = __fmt(document.getElementById('mArtist')?.value);
    const key = __fmt(document.getElementById('mKey')?.value);
    const capo = __fmt(document.getElementById('mCapo')?.value);
    const bpm = __fmt(document.getElementById('mTempo')?.value);
    const dur = __fmt(document.getElementById('mDur')?.value);
    const pill = document.getElementById('metaSummary');
    if (pill) pill.textContent = `${title} ‚Ä¢ ${artist}  |  Key ${key} ‚Ä¢ Capo ${capo} ‚Ä¢ ${bpm} BPM ‚Ä¢ ${dur}`;
}

function onMetaChanged(){
    // update raw meta block + preserve body
    __rawEditorText = __getRawEditorText();
    __setEditorFromRaw(__rawEditorText);
    updateMetaSummaryUI();
    saveAndRender(); // renders preview + persists
}
}

function syncFieldsToEditor(){
  let content = document.getElementById('editor').value;
  const mappings = [
    { id:'mTitle', tag:'title' },
    { id:'mArtist', tag:'artist' },
    { id:'mSinger', tag:'singer' },
    { id:'mPersona', tag:'version' },  // ‚úÖ standardised
    { id:'mKey', tag:'key' },
    { id:'mCapo', tag:'capo' },
    { id:'mTempo', tag:'tempo' },
    { id:'mDur', tag:'duration' }
  ];
  mappings.forEach(m => {
    const el = document.getElementById(m.id);
    if (!el) return;
    const val = el.value;
    const regex = new RegExp(`\\{${m.tag}:.*?\\}`, 'i');
    if (content.match(regex)) content = content.replace(regex, `{${m.tag}: ${val}}`);
    else if (val) content = `{${m.tag}: ${val}}\n` + content;
  });

  // If legacy persona exists, remove it to avoid duplicates
  content = content.replace(/\{persona:\s*.*?\}\s*\n?/ig, '');

  __setEditorFromRaw(content);
  saveAndRender();
}

function saveAndRender() {
    const rawText = __getRawEditorText();
    __rawEditorText = rawText;

    const data = {
        title: document.getElementById('mTitle').value, artist: document.getElementById('mArtist').value,
        singer: document.getElementById('mSinger').value, version: document.getElementById('mPersona').value,
        key: document.getElementById('mKey').value, capo: document.getElementById('mCapo').value,
        tempo: document.getElementById('mTempo').value, duration: document.getElementById('mDur').value,
        content: rawText
    };
    localStorage.setItem('chordpro_studio_save', JSON.stringify(data));
    updateMetaSummaryUI();
    render();
}

function render(){
  const title = document.getElementById('mTitle').value || 'Song';
  const artist = document.getElementById('mArtist').value || 'Artist';
  const capo = document.getElementById('mCapo').value;

  let headerHtml = `<div style="text-align:center; font-weight:bold; border-bottom:1px solid #444; margin-bottom:15px; padding-bottom:10px; color:var(--lyric-clr)">`;
  headerHtml += `${title} | ${artist}`;
  if (capo) headerHtml += `<span class="capo-badge">CAPO ${capo}</span>`;
  headerHtml += `</div>`;

  let inChorus = false;
  let bodyHtml = document.getElementById('editor').value.split('\n').map(line => {
    let p = line.trim();

    if (p.includes("---PAGE BREAK---")) return '<div class="page-break"></div>';

    if (p.match(/\{(start_of_chorus|soc)\}/i)) { inChorus = true; return ""; }
    if (p.match(/\{(end_of_chorus|eoc)\}/i)) { inChorus = false; return ""; }

    let cMatch = p.match(/\{c(?:omment)?:\s*(.*?)\}/i);
    if (cMatch) {
      inChorus = cMatch[1].toLowerCase().includes("chorus");
      return `<span class="p-section">${cMatch[1]}</span>`;
    }

    if (p.startsWith('{')) return "";
    if (p === "") return "<div>&nbsp;</div>";

    let lineClass = inChorus ? "p-chorus-text" : "";
    return `<div class="${lineClass}">${p.replace(/\[([^\]]+)\]/g, `<span class="p-chord">$1</span>`)}</div>`;
  }).join("");

  document.getElementById('preview').innerHTML = headerHtml + bodyHtml;
}

function updateUI(){
  const themeUser = document.getElementById('userTheme').value;
  const mode = document.body.classList.contains('light-theme') ? 'light' : 'dark';
  let settings = JSON.parse(localStorage.getItem('theme_settings')) || {};
  settings[themeUser] = settings[themeUser] || {};
  settings[themeUser][mode] = {
    bg: document.getElementById('bgColor').value,
    cho: document.getElementById('choColor').value,
    sec: document.getElementById('secColor').value,
    chorus: document.getElementById('chorusColor').value,
    size: document.getElementById('fontSize').value,
    line: document.getElementById('lineSpacing').value
  };
  localStorage.setItem('theme_settings', JSON.stringify(settings));

  const root = document.documentElement;
  const s = settings[themeUser][mode];
  root.style.setProperty('--ipad-bg', s.bg);
  root.style.setProperty('--chord-clr', s.cho);
  root.style.setProperty('--section-clr', s.sec);
  root.style.setProperty('--chorus-clr', s.chorus);
  root.style.setProperty('--font-size', s.size + 'px');
  root.style.setProperty('--line-height', s.line);

  const hex = s.bg.replace('#','');
  const r = parseInt(hex.substring(0,2),16),
        g = parseInt(hex.substring(2,4),16),
        b = parseInt(hex.substring(4,6),16);
  root.style.setProperty('--lyric-clr', (r*0.299 + g*0.587 + b*0.114) < 128 ? '#ffffff' : '#000000');

  document.getElementById('v-size').innerText = s.size + 'px';
  document.getElementById('v-line').innerText = s.line;
  render();
}

function loadThemeSettings(){
  const themeUser = document.getElementById('userTheme').value;
  const mode = document.body.classList.contains('light-theme') ? 'light' : 'dark';
  const settings = JSON.parse(localStorage.getItem('theme_settings')) || {};
  const s = (settings[themeUser] && settings[themeUser][mode]) ? settings[themeUser][mode] : DEFAULTS[mode];

  document.getElementById('bgColor').value = s.bg;
  document.getElementById('choColor').value = s.cho;
  document.getElementById('secColor').value = s.sec;
  document.getElementById('chorusColor').value = s.chorus;
  document.getElementById('fontSize').value = s.size;
  document.getElementById('lineSpacing').value = s.line;
  updateUI();
}

function toggleTheme(){
  document.body.classList.toggle('light-theme');
  document.getElementById('themeToggleBtn').innerText =
    document.body.classList.contains('light-theme') ? "‚òÄÔ∏è Light" : "üåô Dark";
  loadThemeSettings();
}

function resetSliders(){
  const mode = document.body.classList.contains('light-theme') ? 'light' : 'dark';
  const s = DEFAULTS[mode];
  document.getElementById('bgColor').value = s.bg;
  document.getElementById('choColor').value = s.cho;
  document.getElementById('secColor').value = s.sec;
  document.getElementById('chorusColor').value = s.chorus;
  document.getElementById('fontSize').value = s.size;
  document.getElementById('lineSpacing').value = s.line;
  updateUI();
}

// Legacy file input import
function handleFileImport(input){
  const reader = new FileReader();
  reader.onload = (e) => {
    const content = e.target.result;
    __setEditorFromRaw(content);
    populateMetaFromChordProText(content);
    saveAndRender();
  };
  reader.readAsText(input.files[0]);
}

function generateUid(){
  try { return crypto.randomUUID(); } catch(e) {}
  return 'uid-' + Math.random().toString(16).slice(2) + '-' + Date.now().toString(16);
}
function ensureUidInEditorText() {
    const raw = __getRawEditorText();
    if (/\{uid:\s*.+?\}/i.test(raw)) {
        __rawEditorText = raw;
        return;
    }
    const uid = generateUid();
    const lines = raw.split(/\r?\n/);
    let i = 0;
    while (i < lines.length && (lines[i].trim() === '' || lines[i].trim().startsWith('#'))) i++;
    lines.splice(i, 0, `{uid: ${uid}}`);
    __setEditorFromRaw(lines.join('\n'));
}

let __needsSaveAsPrompt = false;

function __suggestChoName(){
  const title = document.getElementById('mTitle')?.value || 'Song';
  const artist = document.getElementById('mArtist')?.value || 'Artist';
  const ver = document.getElementById('mPersona')?.value || 'Adam';
  return `${title} - ${artist} (${ver}).cho`;
}

async function __saveChoViaPickerAlwaysPrompt(){
  if (!window.showSaveFilePicker) return false;
  try{
    const handle = await window.showSaveFilePicker({
      suggestedName: __suggestChoName(),
      types: [{ description:'ChordPro', accept: { 'text/plain': ['.cho'] } }]
    });

    ensureUidInEditorText();

    const w = await handle.createWritable();
    await w.write(__getRawEditorText());
    await w.close();

    __fsHandle = handle;
    const f = await handle.getFile();
    __fsLastModified = f.lastModified;
    __openedFileName = f.name;

    const sb = document.getElementById('saveBackBtn');
    if (sb) sb.style.display = 'inline-block';

    __needsSaveAsPrompt = false;
    __hideSaveAsBanner();
    __toast('Saved new file: ' + f.name);
    return true;
  }catch(e){
    return false;
  }
}

function downloadCho(){
  if (__needsSaveAsPrompt && window.showSaveFilePicker) {
    __saveChoViaPickerAlwaysPrompt();
    return;
  }
  ensureUidInEditorText();
  const title = document.getElementById('mTitle').value || 'Song';
  const artist = document.getElementById('mArtist').value || 'Artist';
  const ver = document.getElementById('mPersona').value || 'Adam';
  const blob = new Blob([__getRawEditorText()], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${title} - ${artist} (${ver}).cho`;
  a.click();
}

function clearAllFields(){
  if (confirm("Clear all?")){
    META_IDS.forEach(id => document.getElementById(id).value = "");
    document.getElementById('editor').value = "";
    saveAndRender();
  }
}

function newSong(){
  META_IDS.forEach(id => document.getElementById(id).value = "");
  document.getElementById('mPersona').value = "Adam";
  document.getElementById('editor').value =
`{title: New Song}
{artist: Artist}
{singer: Adam}
{version: Adam}

{comment: Verse 1}
[G] Lyrics here...`;
  saveAndRender();
}

function transpose(dir){
  const editor = document.getElementById('editor');
  editor.value = editor.value.replace(/\[([A-G][b#]?)(.*?)\]/g, (m, n, s) => {
    let clean = n.replace('Db','C#').replace('Eb','D#').replace('Gb','F#').replace('Ab','G#').replace('Bb','A#');
    let idx = scale.indexOf(clean);
    return `[${scale[(idx + dir + 12) % 12]}${s}]`;
  });
  saveAndRender();
}

function insertPageBreak(){
  const s = prompt("Page turn to:", "Chorus");
  if (s !== null){
    document.getElementById('editor').value += `\n---PAGE BREAK--- [${s || 'Turn'}]\n`;
    saveAndRender();
  }
}

function insertBlankLine(){
  const editor = document.getElementById('editor');
  const cursorPos = editor.selectionStart;
  const textBefore = editor.value.substring(0, cursorPos);
  const textAfter = editor.value.substring(cursorPos);
  editor.value = textBefore + '\n' + textAfter;
  editor.selectionStart = editor.selectionEnd = cursorPos + 1;
  saveAndRender();
}

function updatePageTitle(){
  document.title = (document.getElementById('mTitle').value || "Song") +
                   " - " +
                   (document.getElementById('mArtist').value || "Artist");
}

function exportPdf(){
  updatePageTitle();
  window.print();
}

document.getElementById('fileInput').addEventListener('change', function(){
  if (this.files && this.files[0]) handleFileImport(this);
});

// ===============================
// Text ‚Üí .cho Converter (unchanged)
// ===============================
function t2cShow(){
  const m = document.getElementById('textToChoModal');
  if (!m) return;
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
  const ta = document.getElementById('t2cInput');
  if (ta) setTimeout(() => ta.focus(), 50);
}
function t2cHide(){
  const m = document.getElementById('textToChoModal');
  if (!m) return;
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
}
function t2cInferFromFilename(raw){
  const s = (raw || '').trim().replace(/\.(docx|txt|cho)$/i, '').trim();
  let version = '';
  let base = s;

  const verMatch = base.match(/\(([^)]+)\)\s*$/);
  if (verMatch){
    version = verMatch[1].trim();
    base = base.replace(/\s*\([^)]+\)\s*$/, '').trim();
  }

  let title = '';
  let artist = '';
  if (base.includes(' - ')){
    const parts = base.split(' - ');
    title = (parts[0] || '').trim();
    artist = (parts.slice(1).join(' - ') || '').trim();
  } else {
    title = base;
  }
  return { title, artist, version };
}
function t2cProcessChords(line){
  const chordRegex = /(^|\s+)([A-G][#b]?(?:m7|maj7|maj|min|m|sus[24]|add[29]|dim|aug|[5679]|11|13)?(?:\/[A-G][#b]?(?:m7|maj7|maj|min|m|sus[24]|add[29]|dim|aug|[5679]|11|13)?)?)(?=\s+|$)/g;
  return line.replace(chordRegex, '$1[$2]');
}
function t2cConvertPlainText(plainText, inferred){
  const lines = (plainText || '').split(/\r?\n/);
  const out = [];

  out.push(`{uid: ${generateUid()}}`);
  if (inferred && inferred.version) out.push(`{version: ${inferred.version}}`);
  if (inferred && inferred.title) out.push(`{title: ${inferred.title}}`);
  if (inferred && inferred.artist) out.push(`{artist: ${inferred.artist}}`);
  out.push('');

  const sectionKeys = /^(verse|chorus|bridge|solo|outro|intro|pre[\s\-]?chorus|page|guitar|adam|pete)\b/i;

  for (let idx=0; idx<lines.length; idx++){
    const raw = lines[idx] || '';
    const trimmed = raw.trim();

    if (!trimmed){ out.push(''); continue; }

    const isTitleLine = idx < 5 && inferred && inferred.title && trimmed.toLowerCase().includes(inferred.title.toLowerCase());

    if (sectionKeys.test(trimmed)){
      const clean = trimmed.replace(/[\[\]{}]/g, '');
      out.push(`{comment: ${clean}}`);
    } else if (isTitleLine){
      out.push(trimmed);
    } else {
      out.push(t2cProcessChords(raw.replace(/\s+$/,'')));
    }
  }
  return out.join('\n');
}
function t2cLoadIntoEditor(chordProText){
  const ed = document.getElementById('editor');
  __setEditorFromRaw(chordProText);
  populateMetaFromChordProText(chordProText);
  saveAndRender();
}
function t2cWire(){
  const btn = document.getElementById('btnTextToCho');
  const closeBtn = document.getElementById('t2cCloseBtn');
  const cancelBtn = document.getElementById('t2cCancelBtn');
  const convertBtn = document.getElementById('t2cConvertBtn');
  const modal = document.getElementById('textToChoModal');

  if (btn) btn.addEventListener('click', t2cShow);
  if (closeBtn) closeBtn.addEventListener('click', t2cHide);
  if (cancelBtn) cancelBtn.addEventListener('click', t2cHide);

  if (convertBtn){
    convertBtn.addEventListener('click', () => {
      const filenameRaw = (document.getElementById('t2cFilename')?.value || '');
      const inputText = (document.getElementById('t2cInput')?.value || '');
      const inferred = t2cInferFromFilename(filenameRaw);
      const chordPro = t2cConvertPlainText(inputText, inferred);
      t2cLoadIntoEditor(chordPro);
      t2cHide();
    });
  }

  if (modal){
    modal.addEventListener('click', (e) => { if (e.target === modal) t2cHide(); });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape'){
      const m = document.getElementById('textToChoModal');
      if (m && m.style.display === 'flex') t2cHide();
    }
  });
}

// ===============================
// v2.7: Save back to file + New Version
// ===============================
let __fsHandle = null;
let __fsLastModified = null;
let __openedFileName = null;

function __toast(msg){
  const t = document.getElementById('snToast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t.__hideTimer);
  t.__hideTimer = setTimeout(() => t.classList.remove('show'), 2400);
}
function __showSaveAsBanner(){ const b = document.getElementById('saveAsBanner'); if (b) b.style.display='flex'; }
function __hideSaveAsBanner(){ const b = document.getElementById('saveAsBanner'); if (b) b.style.display='none'; }
function __wireSaveAsBanner(){
  const x = document.getElementById('saveAsBannerHideBtn');
  if (x) x.addEventListener('click', __hideSaveAsBanner);
}

async function openChoFile(){
  if (window.showOpenFilePicker){
    try{
      const [h] = await window.showOpenFilePicker({
        multiple:false,
        types:[{ description:'ChordPro', accept:{ 'text/plain': ['.cho','.txt'] } }]
      });
      __fsHandle = h;
      const f = await h.getFile();
      __fsLastModified = f.lastModified;
      __openedFileName = f.name;

      const text = await f.text();
      __setEditorFromRaw(text);
      populateMetaFromChordProText(text);
      saveAndRender();

      const sb = document.getElementById('saveBackBtn');
      if (sb) sb.style.display='inline-block';
      __toast('Opened: ' + f.name);
      return;
    }catch(e){
      // user cancelled; fall through
    }
  }
  document.getElementById('fileInput').click();
}

async function saveBackToFile(){
  if (!__fsHandle){
    alert('Save back to file is only available when you open a file using Chrome/Edge ‚ÄúOpen‚Äù.');
    return;
  }
  try{
    const current = await __fsHandle.getFile();
    if (__fsLastModified && current.lastModified !== __fsLastModified){
      const ok = confirm('File changed on disk since you opened it. Overwrite anyway?');
      if (!ok) return;
    }

    ensureUidInEditorText();

    const w = await __fsHandle.createWritable();
    await w.write(__getRawEditorText());
    await w.close();

    const refreshed = await __fsHandle.getFile();
    __fsLastModified = refreshed.lastModified;
    __openedFileName = refreshed.name;

    __toast('Saved back to: ' + refreshed.name);
  }catch(e){
    console.error(e);
    alert('Save back failed. Check Console for details.');
  }
}

function nvShow(){
  const m = document.getElementById('newVersionModal');
  if (!m) return;
  const curVer = document.getElementById('mPersona')?.value || '';
  const verText = document.getElementById('nvVersionText');
  if (verText && !verText.value) verText.value = curVer || 'Pete';
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
  setTimeout(() => verText && verText.focus(), 30);
}
function nvHide(){
  const m = document.getElementById('newVersionModal');
  if (!m) return;
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
}
function __upsertTag(text, tag, value){
  const re = new RegExp(`\\{${tag}:\\s*.*?\\}`, 'i');
  if (re.test(text)) return text.replace(re, `{${tag}: ${value}}`);
  return `{${tag}: ${value}}\n` + text;
}
function nvCreate(){
  const ver = (document.getElementById('nvVersionText')?.value || '').trim();
  if (!ver){ alert('Please enter a version name (e.g. Pete).'); return; }

  const ed = document.getElementById('editor');
  if (!ed) return;

  // 1) Ensure the editor text contains the current meta fields BEFORE forking
  const meta = {
    title:   (document.getElementById('mTitle')?.value || '').trim(),
    artist:  (document.getElementById('mArtist')?.value || '').trim(),
    singer:  (document.getElementById('mSinger')?.value || '').trim(),
    key:     (document.getElementById('mKey')?.value || '').trim(),
    capo:    (document.getElementById('mCapo')?.value || '').trim(),
    tempo:   (document.getElementById('mTempo')?.value || '').trim(),
    dur:     (document.getElementById('mDur')?.value || '').trim()
  };

  // Upsert core tags (only if value exists)
  if (meta.title)  ed.value = __upsertTag(ed.value, 'title', meta.title);
  if (meta.artist) ed.value = __upsertTag(ed.value, 'artist', meta.artist);
  if (meta.singer) ed.value = __upsertTag(ed.value, 'singer', meta.singer);
  if (meta.key)    ed.value = __upsertTag(ed.value, 'key', meta.key);
  if (meta.capo)   ed.value = __upsertTag(ed.value, 'capo', meta.capo);
  if (meta.tempo)  ed.value = __upsertTag(ed.value, 'tempo', meta.tempo);
  if (meta.dur)    ed.value = __upsertTag(ed.value, 'duration', meta.dur);

  // 2) Ensure UID exists, then replace it with a new one (fork)
  if (!/\{uid:/i.test(ed.value)) {
    ed.value = `{uid: ${generateUid()}}\n` + ed.value;
  }
  ed.value = ed.value.replace(/\{uid:\s*.*?\}/i, `{uid: ${generateUid()}}`);

  // 3) Set version for the fork + remove legacy persona to avoid duplicates
  ed.value = __upsertTag(ed.value, 'version', ver);
  ed.value = ed.value.replace(/\{persona:\s*.*?\}\s*\n?/ig, '');

  // 4) Re-populate meta inputs from the editor (so UI shows original values)
  populateMetaFromChordProText(ed.value);

  // 5) Update dropdown if option exists
  const vSel = document.getElementById('mPersona');
  if (vSel) {
    const has = Array.from(vSel.options).some(o => o.value === ver);
    if (has) vSel.value = ver;
  }

  // 6) SAFETY: clear file handle so you can't overwrite the original
  __fsHandle = null;
  __fsLastModified = null;
  __openedFileName = null;
  const sb = document.getElementById('saveBackBtn');
  if (sb) sb.style.display = 'none';

  // 7) Force Save As prompt (Chrome/Edge)
  __needsSaveAsPrompt = true;
  __showSaveAsBanner();

  saveAndRender();
  nvHide();
  __toast('New version created: ' + ver);
}

function __onReady(fn){
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
  else fn();
}
function nvWire(){
  const closeBtn = document.getElementById('nvCloseBtn');
  const cancelBtn = document.getElementById('nvCancelBtn');
  const createBtn = document.getElementById('nvCreateBtn');
  const modal = document.getElementById('newVersionModal');

  if (closeBtn) closeBtn.addEventListener('click', nvHide);
  if (cancelBtn) cancelBtn.addEventListener('click', nvHide);
  if (createBtn) createBtn.addEventListener('click', nvCreate);
  if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) nvHide(); });

  window.nvShow = nvShow;
  window.saveBackToFile = saveBackToFile;
  window.openChoFile = openChoFile;
}

__onReady(() => {
  initFontSelect();
  __applyHideTagsUI();

  const toggleBtn = document.getElementById('toggleTagsBtn');
  if (toggleBtn) toggleBtn.addEventListener('click', (e) => { e.preventDefault(); toggleTagsInEditor(); });

  // Load last session (if present)
  try{
    const saved = JSON.parse(localStorage.getItem('chordpro_studio_save') || 'null');
    if (saved && typeof saved === 'object'){
      if (document.getElementById('mTitle'))   document.getElementById('mTitle').value = saved.title || '';
      if (document.getElementById('mArtist'))  document.getElementById('mArtist').value = saved.artist || '';
      if (document.getElementById('mSinger'))  document.getElementById('mSinger').value = saved.singer || 'Adam';
      if (document.getElementById('mPersona')) document.getElementById('mPersona').value = saved.version || 'Adam';
      if (document.getElementById('mKey'))     document.getElementById('mKey').value = saved.key || '';
      if (document.getElementById('mCapo'))    document.getElementById('mCapo').value = saved.capo || '';
      if (document.getElementById('mTempo'))   document.getElementById('mTempo').value = saved.tempo || '';
      if (document.getElementById('mDur'))     document.getElementById('mDur').value = saved.duration || '';
      if (saved.content) __setEditorFromRaw(saved.content);
    }
  }catch(e){ /* ignore */ }

  updateMetaSummaryUI();
  loadThemeSettings();
  render();
  t2cWire();
});

    __onReady(nvWire);
    __onReady(__wireSaveAsBanner);
</script>

<!-- New Version Modal -->
<div id="newVersionModal" aria-hidden="true">
  <div class="nv-box" role="dialog" aria-modal="true" aria-label="Create new version">
    <div class="nv-head">
      <div>üß¨ Create new version</div>
      <button type="button" id="nvCloseBtn" title="Close">Close</button>
    </div>
    <div class="nv-body">
      <div style="display:grid; gap:6px;">
        <label style="opacity:.85; font-size:12px; font-weight:bold;">Version name (dropdown + free text)</label>
        <input id="nvVersionText" list="nvVersionList" placeholder="e.g. Pete">
        <datalist id="nvVersionList">
          <option value="Adam"></option>
          <option value="Pete"></option>
          <option value="Both"></option>
        </datalist>
      </div>

      <div class="nv-actions">
        <button type="button" id="nvCreateBtn" style="background: var(--btn-accent);">Create version</button>
        <button type="button" id="nvCancelBtn">Cancel</button>
      </div>

      <div style="opacity:.7; font-size:12px; margin-top:8px;">
        This creates a fork: new UID + updates {version}. It also clears the ‚ÄúSave back to file‚Äù handle to prevent overwriting the original.
      </div>
    </div>
  </div>
</div>

<div id="snToast" aria-live="polite" aria-atomic="true"></div>
<div class="app-footer"><strong>ChordPro Edit</strong> ‚Ä¢ Build 2026-02-08</div>

</body>
</html>
