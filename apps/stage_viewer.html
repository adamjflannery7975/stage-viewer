<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChordPro Studio ‚Äì Stage Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA (paths relative to /apps/) -->
  <link rel="manifest" href="../manifest.json">
  <link rel="apple-touch-icon" href="../icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111111">

  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --card:#1f2430;
      --text:#f5f7ff;
      --muted:#aab2c5;
      --border:rgba(255,255,255,0.10);
      --accent:#6aa3ff;
      --accent2:#7ee787;
      --danger:#ff6a6a;

      --songbg:#0b0d12;
      --songborder:rgba(255,255,255,0.12);
      --chord:#ffd479;

      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    body.light{
      --bg:#f2f3f6;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#121418;
      --muted:#5c6472;
      --border:rgba(0,0,0,0.12);
      --accent:#2a66ff;
      --accent2:#1f8a3b;
      --danger:#c92828;

      --songbg:#ffffff;
      --songborder:rgba(0,0,0,0.14);
      --chord:#b05a00;

      --shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    * { box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:30;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      transition: transform 180ms ease, opacity 180ms ease;
    }

    /* Auto-hide top bar when in stageMode (menu hidden) */
    body.stageMode header.autoHidden{
      transform: translateY(-120%);
      opacity: 0;
      pointer-events:none;
    }

    .brand{
      font-weight:800;
      letter-spacing:0.2px;
      margin-right:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    select, button{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      outline:none;
    }
    button{ cursor:pointer; }
    button:hover{ border-color:rgba(255,255,255,0.22); }
    body.light button:hover{ border-color:rgba(0,0,0,0.22); }

    .btnPrimary{
      border-color: rgba(106,163,255,0.45);
    }
    .btnPrimary:hover{
      border-color: rgba(106,163,255,0.8);
    }

    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pillAccent{
      color: var(--text);
      border-color: rgba(126,231,135,0.40);
      background: rgba(126,231,135,0.12);
    }

    .status{
      font-size:13px;
      color:var(--muted);
      padding: 8px 12px;
      max-width: 1200px;
      margin: 0 auto;
      display:none; /* we‚Äôre hiding the redundant ‚ÄúLoaded‚Ä¶‚Äù line */
    }

    /* App layout */
    .app{
      display:flex;
      gap:12px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px;
      padding-top: 10px;
    }

    /* Sidebar */
    .sidebar{
      width: 340px;
      min-width: 340px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .sidebarHeader{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
    }
    body.light .sidebarHeader{
      background: rgba(0,0,0,0.03);
    }
    .sidebarHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:0.02em;
    }
    .sidebarBody{
      padding: 10px 10px 12px 10px;
    }

    .miniRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 10px;
    }

    .sectionTitle{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      margin: 10px 4px 6px;
    }

    .songList{
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: var(--card);
    }

    .songItem{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .songItem:last-child{ border-bottom:none; }
    .songItem:hover{
      background: rgba(106,163,255,0.10);
    }
    body.light .songItem:hover{
      background: rgba(42,102,255,0.08);
    }
    .songItem.selected{
      background: rgba(126,231,135,0.10);
    }
    body.light .songItem.selected{
      background: rgba(31,138,59,0.08);
    }
    .songTop{
      display:flex;
      gap:8px;
      align-items:baseline;
      justify-content:space-between;
    }
    .songTitleMini{
      font-weight:800;
      font-size:14px;
      line-height:1.2;
    }
    .songArtistMini{
      color: var(--muted);
      font-size:12px;
    }
    .songMetaMini{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
    }

    /* Main panel */
    .main{
      flex:1;
      min-width: 320px;
    }

    .songPanel{
      background:var(--songbg);
      border:1px solid var(--songborder);
      border-radius:14px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .songHeader{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:12px 14px;
      background:var(--card);
      border-bottom:1px solid var(--border);
      position: sticky;
      top: 0; /* inside panel it will ‚Äúpin‚Äù nicely */
      z-index: 5;
    }
    .songTitle{
      font-weight:900;
      font-size:20px;
      letter-spacing:0.2px;
    }
    .songMeta{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    .songHeaderLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 240px;
    }
    .songHeaderRight{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .songBody{
      padding:16px 16px 80px 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:18px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
      overflow-x:auto;
      max-height: calc(100vh - 150px);
      overflow-y:auto;
    }

    .line{
      display:block;
      padding:1px 0;
    }
    .chord{
      color:var(--chord);
      font-weight:900;
    }
    .section{
      color:var(--accent2);
      font-weight:900;
      margin-top:12px;
      display:block;
    }
    .warn{
      color:var(--danger);
      font-weight:800;
    }

    /* Collapsed sidebar (menu hidden) */
    body.stageMode .sidebar{
      display:none;
    }
    body.stageMode .app{
      max-width: 1100px;
    }

    /* Floating scroll buttons */
    .floatNav{
      position: fixed;
      right: 16px;
      bottom: 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:40;
    }
    .floatNav button{
      width: 48px;
      height: 48px;
      border-radius: 14px;
      font-size: 18px;
      box-shadow: var(--shadow);
      border-color: rgba(106,163,255,0.35);
    }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 16px;
    }
    .modal{
      width: min(720px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    body.light .modalHeader{
      background: rgba(0,0,0,0.03);
    }
    .modalHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.02em;
    }
    .modalBody{
      padding: 12px 14px;
      color: var(--text);
    }
    .kv{
      display:grid;
      grid-template-columns: 180px 1fr;
      gap:8px 12px;
      align-items:baseline;
      font-size: 13px;
    }
    .k{
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
    }
    .v{
      word-break: break-word;
    }
    .divider{
      height:1px;
      background: var(--border);
      margin: 12px 0;
    }

    @media (max-width: 980px){
      .app{
        flex-direction:column;
      }
      .sidebar{
        width:100%;
        min-width: 0;
      }
      body.stageMode .sidebar{
        display:none;
      }
    }
  </style>
</head>

<body>
  <header id="topHeader">
    <div class="brand">
      <button id="menuBtn" title="Show/hide menu">‚ò∞ Menu</button>
      <span>Stage Viewer</span>
    </div>

    <!-- Collections mode (preferred) -->
    <label id="collectionWrap" style="display:none;">
      Collection:
      <select id="collectionSelect" disabled>
        <option>Loading‚Ä¶</option>
      </select>
    </label>

    <label id="setWrap" style="display:none;">
      Set:
      <select id="setSelect" disabled>
        <option>Loading‚Ä¶</option>
      </select>
    </label>

    <!-- Fallback setlist mode -->
    <label id="setlistWrap" style="display:none;">
      Setlist:
      <select id="setlistSelect" disabled>
        <option>Loading‚Ä¶</option>
      </select>
    </label>

    <label>
      Persona:
      <select id="personaSelect" disabled>
        <option>Loading‚Ä¶</option>
      </select>
    </label>

    <button id="infoBtn" title="Info">i</button>
    <button id="refreshBtn" title="Reload library index">Refresh</button>
    <button id="themeBtn" title="Toggle light/dark">Toggle Theme</button>
  </header>

  <div class="status" id="status">Loading library‚Ä¶</div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebarHeader">
        <h3>Library</h3>
        <span class="pill" id="libMiniPill">‚Äî</span>
      </div>
      <div class="sidebarBody">
        <div class="miniRow">
          <span class="pill" id="songsCountPill">Songs: ‚Äî</span>
          <span class="pill" id="setlistsCountPill">Lists: ‚Äî</span>
        </div>

        <div class="sectionTitle">Songs</div>
        <div class="songList" id="songList"></div>
      </div>
    </aside>

    <section class="main">
      <div class="songPanel" id="songPanel" style="display:none;">
        <div class="songHeader">
          <div class="songHeaderLeft">
            <div class="songTitle" id="songTitle">‚Äî</div>
            <div class="songMeta" id="songMeta">‚Äî</div>
          </div>

          <!-- Prev/Next ALWAYS visible here (survives header auto-hide) -->
          <div class="songHeaderRight">
            <button id="prevBtn" title="Previous song">¬´ Prev</button>
            <button id="nextBtn" title="Next song" class="btnPrimary">Next ¬ª</button>
            <span class="pill pillAccent" id="capoPill" style="display:none;">CAPO ‚Äî</span>
            <span class="pill" id="setPill" style="display:none;">‚Äî</span>
          </div>
        </div>
        <div class="songBody" id="songBody"></div>
      </div>

      <div id="emptyState" class="songPanel" style="padding:14px; color:var(--muted);">
        No song loaded yet.
      </div>
    </section>
  </div>

  <div class="floatNav" id="floatNav" style="display:none;">
    <button id="scrollUpBtn" title="Scroll up">‚ñ≤</button>
    <button id="scrollDownBtn" title="Scroll down">‚ñº</button>
  </div>

  <!-- Info Modal -->
  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Info</h3>
        <button id="closeModalBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="kv" id="infoKv"></div>
      </div>
    </div>
  </div>

  <script>
    // --- PWA SW (paths relative to /apps/) ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('../serviceWorker.js').catch(() => {});
    }

    // --- Theme ---
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('cps_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });
    (function initTheme(){
      const t = localStorage.getItem('cps_theme');
      if (t === 'light') document.body.classList.add('light');
    })();

    // --- DOM ---
    const topHeader = document.getElementById('topHeader');

    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');

    const menuBtn = document.getElementById('menuBtn');

    // Selects
    const collectionWrap = document.getElementById('collectionWrap');
    const collectionSelect = document.getElementById('collectionSelect');
    const setWrap = document.getElementById('setWrap');
    const setSelect = document.getElementById('setSelect');

    const setlistWrap = document.getElementById('setlistWrap');
    const setlistSelect = document.getElementById('setlistSelect');

    const personaSelect = document.getElementById('personaSelect');

    const songListEl = document.getElementById('songList');
    const songPanel = document.getElementById('songPanel');
    const emptyState = document.getElementById('emptyState');
    const songTitleEl = document.getElementById('songTitle');
    const songMetaEl = document.getElementById('songMeta');
    const songBodyEl = document.getElementById('songBody');
    const capoPill = document.getElementById('capoPill');
    const setPill = document.getElementById('setPill');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const floatNav = document.getElementById('floatNav');
    const scrollUpBtn = document.getElementById('scrollUpBtn');
    const scrollDownBtn = document.getElementById('scrollDownBtn');

    const libMiniPill = document.getElementById('libMiniPill');
    const songsCountPill = document.getElementById('songsCountPill');
    const setlistsCountPill = document.getElementById('setlistsCountPill');

    // Info modal
    const infoBtn = document.getElementById('infoBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const infoKv = document.getElementById('infoKv');

    // --- State ---
    let LIB = null;
    let SONG_MAP = new Map();

    // Two modes:
    // 1) Collections mode: LIB.collections exists. User chooses collection + set; we render songs from that set.
    // 2) Fallback setlist mode: LIB.setlists exists. User chooses setlist; we render songs from its sets.
    let USING_COLLECTIONS = false;

    let CURRENT_COLLECTION_ID = null;
    let CURRENT_SET_ID = null;

    let CURRENT_SETLIST_ID = null;

    let CURRENT_UID_ORDER = [];
    let CURRENT_UID = null;

    // Header auto-hide timer when stageMode
    let headerHideTimer = null;

    function setStatus(msg){
      // status line is hidden; keep for debugging if you want later
      statusEl.textContent = msg;
    }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }

    async function fetchText(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.text();
    }

    function unique(arr){
      return Array.from(new Set(arr)).filter(Boolean);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function buildSongMap(){
      SONG_MAP = new Map();
      (LIB.songs || []).forEach(s => {
        if (s && s.uid) SONG_MAP.set(String(s.uid), s);
      });
    }

    function computePersonas(){
      const p = [];
      (LIB.songs || []).forEach(s => {
        if (Array.isArray(s.personas)) p.push(...s.personas);
        if (s.files && typeof s.files === 'object') {
          Object.keys(s.files).forEach(k => { if (k && k !== '_default') p.push(k); });
        }
      });
      return unique(p).sort((a,b)=>a.localeCompare(b));
    }

    function resolveChoPathForPersona(song, persona){
      if (song?.files && typeof song.files === 'object'){
        if (persona && song.files[persona]) return song.files[persona];
        if (song.files["_default"]) return song.files["_default"];
        const keys = Object.keys(song.files);
        if (keys.length) return song.files[keys[0]];
      }
      return null;
    }

    function parseChordProMeta(text){
      const meta = {};
      const tagRe = /^\s*\{([a-zA-Z0-9_\-]+)\s*:\s*(.*?)\}\s*$/;
      for (const line of text.split('\n')){
        const m = tagRe.exec(line);
        if (!m) continue;
        const k = m[1].trim().toLowerCase();
        const v = m[2].trim();
        if (!(k in meta)) meta[k] = v;
      }
      return meta;
    }

    function chordProToHtml(text){
      const lines = text.split('\n');
      const out = [];
      const isTag = (line) => /^\s*\{[^\}]+\}\s*$/.test(line);

      for (let raw of lines){
        const line = raw.replace(/\r$/, '');

        if (/^\s*\{soc\}\s*$/i.test(line) || /^\s*\{start_of_chorus\}\s*$/i.test(line)){
          out.push(`<span class="section">[CHORUS]</span>`);
          continue;
        }
        if (/^\s*\{eoc\}\s*$/i.test(line) || /^\s*\{end_of_chorus\}\s*$/i.test(line)){
          out.push(`<span class="section">[/CHORUS]</span>`);
          continue;
        }

        const mComment = /^\s*\{(?:c|comment)\s*:\s*(.*?)\}\s*$/i.exec(line);
        if (mComment){
          out.push(`<span class="section">${escapeHtml(mComment[1])}</span>`);
          continue;
        }

        if (isTag(line)) continue;

        const html = escapeHtml(line).replace(/\[([^\]]+)\]/g, (_m, chord) => {
          return `<span class="chord">[${escapeHtml(chord)}]</span>`;
        });

        out.push(`<span class="line">${html || '&nbsp;'}</span>`);
      }
      return out.join('');
    }

    function renderSidebarStats(){
      const songCount = (LIB.songs || []).length;
      songsCountPill.textContent = `Songs: ${songCount}`;

      const listCount = USING_COLLECTIONS
        ? (Array.isArray(LIB.collections) ? LIB.collections.length : 0)
        : (Array.isArray(LIB.setlists) ? LIB.setlists.length : 0);

      setlistsCountPill.textContent = USING_COLLECTIONS ? `Collections: ${listCount}` : `Lists: ${listCount}`;
      libMiniPill.textContent = LIB.lastConsolidated ? `Updated: ${LIB.lastConsolidated}` : `Updated: ‚Äî`;
    }

    // ---------- Selection Model (Collections mode) ----------
    function getCollectionById(id){
      return (LIB.collections || []).find(c => String(c.id) === String(id));
    }
    function getSetFromCollection(collection, setId){
      const sets = Array.isArray(collection?.sets) ? collection.sets : [];
      return sets.find(s => String(s.id) === String(setId));
    }

    function populateCollectionSelect(){
      const cols = Array.isArray(LIB.collections) ? LIB.collections : [];
      collectionSelect.innerHTML = '';
      cols.forEach(c => {
        const opt = document.createElement('option');
        opt.value = String(c.id);
        opt.textContent = c.name || c.id || '(collection)';
        collectionSelect.appendChild(opt);
      });

      const saved = localStorage.getItem('cps_collection');
      const ids = cols.map(c => String(c.id));
      const pick = (saved && ids.includes(saved)) ? saved : (ids[0] || null);

      if (pick){
        collectionSelect.value = pick;
        CURRENT_COLLECTION_ID = pick;
      }

      collectionSelect.disabled = !pick;
    }

    function populateSetSelect(){
      const col = getCollectionById(CURRENT_COLLECTION_ID);
      const sets = Array.isArray(col?.sets) ? col.sets : [];

      setSelect.innerHTML = '';
      sets.forEach(s => {
        const opt = document.createElement('option');
        opt.value = String(s.id);
        opt.textContent = s.name || s.id || '(set)';
        setSelect.appendChild(opt);
      });

      const savedKey = `cps_set_${CURRENT_COLLECTION_ID || ''}`;
      const saved = localStorage.getItem(savedKey);
      const ids = sets.map(s => String(s.id));
      const pick = (saved && ids.includes(saved)) ? saved : (ids[0] || null);

      if (pick){
        setSelect.value = pick;
        CURRENT_SET_ID = pick;
      } else {
        CURRENT_SET_ID = null;
      }

      setSelect.disabled = !pick;
    }

    function buildUidOrderFromCurrentSelection(){
      if (USING_COLLECTIONS){
        const col = getCollectionById(CURRENT_COLLECTION_ID);
        if (!col) return [];
        const set = getSetFromCollection(col, CURRENT_SET_ID);
        const uids = Array.isArray(set?.songs) ? set.songs.map(x => String(x)) : [];
        return uids;
      } else {
        const sl = findSetlistById(CURRENT_SETLIST_ID);
        if (!sl) return [];
        return buildUidOrderFromSetlist(sl);
      }
    }

    // ---------- Fallback Setlist mode ----------
    function ensureVirtualAllSongsSetlist(){
      if (!Array.isArray(LIB.setlists) || !LIB.setlists.length){
        const uids = Array.from(SONG_MAP.keys());
        uids.sort((a,b)=>{
          const sa = SONG_MAP.get(a), sb = SONG_MAP.get(b);
          const ta = (sa?.title||"").toLowerCase(), tb = (sb?.title||"").toLowerCase();
          const aa = (sa?.artist||"").toLowerCase(), ab = (sb?.artist||"").toLowerCase();
          if (ta !== tb) return ta.localeCompare(tb);
          if (aa !== ab) return aa.localeCompare(ab);
          return a.localeCompare(b);
        });

        LIB.setlists = [{
          id: "_all_songs",
          name: "All Songs",
          notes: "Virtual (auto-generated)",
          sets: [{ id: "main", name: "All Songs", songs: uids }]
        }];
      }
    }

    function populateSetlistSelect(){
      setlistSelect.innerHTML = '';
      const setlists = Array.isArray(LIB.setlists) ? LIB.setlists : [];
      setlists.forEach(sl => {
        const opt = document.createElement('option');
        opt.value = String(sl.id || sl.name || '');
        opt.textContent = sl.name || sl.id || '(unnamed)';
        setlistSelect.appendChild(opt);
      });

      const saved = localStorage.getItem('cps_setlist');
      const values = setlists.map(sl => String(sl.id || sl.name || ''));
      const pick = (saved && values.includes(saved)) ? saved : values[0];

      setlistSelect.value = pick;
      CURRENT_SETLIST_ID = pick;
      setlistSelect.disabled = false;
    }

    function findSetlistById(id){
      const setlists = Array.isArray(LIB.setlists) ? LIB.setlists : [];
      return setlists.find(sl => String(sl.id || sl.name || '') === String(id));
    }

    function buildUidOrderFromSetlist(setlist){
      const uids = [];
      const sets = Array.isArray(setlist?.sets) ? setlist.sets : [];
      sets.forEach(s => {
        const arr = Array.isArray(s.songs) ? s.songs : [];
        arr.forEach(uid => uids.push(String(uid)));
      });
      return uids;
    }

    // ---------- Shared rendering ----------
    function renderSetPill(){
      if (USING_COLLECTIONS){
        const col = getCollectionById(CURRENT_COLLECTION_ID);
        const set = col ? getSetFromCollection(col, CURRENT_SET_ID) : null;
        const label = col
          ? `${(col.name || col.id)} ‚Ä¢ ${(set?.name || set?.id || 'Set')}`
          : '‚Äî';
        setPill.style.display = 'inline-block';
        setPill.textContent = label;
      } else {
        const sl = findSetlistById(CURRENT_SETLIST_ID);
        setPill.style.display = 'inline-block';
        setPill.textContent = sl ? (sl.name || sl.id || 'Setlist') : '‚Äî';
      }
    }

    function renderSongList(){
      CURRENT_UID_ORDER = buildUidOrderFromCurrentSelection();
      songListEl.innerHTML = '';

      if (!CURRENT_UID_ORDER.length){
        songListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">No songs in this selection.</div>`;
        return;
      }

      CURRENT_UID_ORDER.forEach(uid => {
        const s = SONG_MAP.get(uid);
        const div = document.createElement('div');
        div.className = 'songItem';
        div.setAttribute('data-uid', uid);

        if (!s){
          div.innerHTML = `
            <div class="songTop">
              <div class="songTitleMini warn">Missing song</div>
              <span class="pill">${escapeHtml(uid)}</span>
            </div>
            <div class="songMetaMini">‚Äî</div>
          `;
          div.addEventListener('click', () => {});
        } else {
          const title = s.title || '(untitled)';
          const artist = s.artist || '(unknown)';
          const singer = s.singer || '‚Äî';
          const duration = s.duration || '‚Äî';
          const tempo = (s.tempo !== null && s.tempo !== undefined && s.tempo !== "") ? s.tempo : '‚Äî';

          div.innerHTML = `
            <div class="songTop">
              <div>
                <div class="songTitleMini">${escapeHtml(title)}</div>
                <div class="songArtistMini">${escapeHtml(artist)}</div>
              </div>
              <span class="pill">üé§ ${escapeHtml(singer)}</span>
            </div>
            <div class="songMetaMini">
              <span>‚è± ${escapeHtml(String(duration))}</span>
              <span>üéõ ${escapeHtml(String(tempo))}</span>
            </div>
          `;
          div.addEventListener('click', () => openSong(uid));
        }

        songListEl.appendChild(div);
      });

      renderSetPill();
    }

    function selectSidebarRow(uid){
      const items = songListEl.querySelectorAll('[data-uid]');
      items.forEach(el => el.classList.toggle('selected', el.getAttribute('data-uid') === uid));
    }

    async function openSong(uid){
      const song = SONG_MAP.get(uid);
      if (!song) return;

      const persona = personaSelect.value || '';
      const choRel = resolveChoPathForPersona(song, persona);
      if (!choRel) return;

      try{
        const url = choRel.startsWith("../") ? choRel : ("../" + choRel);
        const choText = await fetchText(url);

        const meta = parseChordProMeta(choText);
        const title = song.title || meta.title || '(untitled)';
        const artist = song.artist || meta.artist || '(unknown)';
        const singer = song.singer || meta.singer || '‚Äî';
        const capo = meta.capo || (song.capo ?? '');
        const key = meta.key || (song.key ?? '');
        const tempo = meta.tempo || (song.tempo ?? '');
        const duration = meta.duration || (song.duration ?? '');

        songTitleEl.textContent = `${title} ‚Äî ${artist}`;

        // Keep this minimal (no UID)
        const metaBits = [];
        metaBits.push(`Persona: ${persona || '‚Äî'}`);
        metaBits.push(`Singer: ${singer || '‚Äî'}`);
        if (key) metaBits.push(`Key: ${key}`);
        if (tempo) metaBits.push(`Tempo: ${tempo}`);
        if (duration) metaBits.push(`Duration: ${duration}`);
        songMetaEl.textContent = metaBits.join('  ‚Ä¢  ');

        if (capo){
          capoPill.style.display = 'inline-block';
          capoPill.textContent = `CAPO ${capo}`;
        } else {
          capoPill.style.display = 'none';
        }

        songBodyEl.innerHTML = chordProToHtml(choText);

        emptyState.style.display = 'none';
        songPanel.style.display = 'block';
        floatNav.style.display = 'flex';

        CURRENT_UID = uid;
        selectSidebarRow(uid);

      }catch(e){
        console.error(e);
      }
    }

    function navDelta(delta){
      if (!CURRENT_UID_ORDER.length) return;
      const i = CURRENT_UID ? CURRENT_UID_ORDER.indexOf(CURRENT_UID) : -1;
      const nextIndex = (i < 0) ? 0 : Math.min(Math.max(i + delta, 0), CURRENT_UID_ORDER.length - 1);
      const uid = CURRENT_UID_ORDER[nextIndex];
      if (uid) openSong(uid);
    }

    function scrollByScreen(dir){
      const amt = Math.round(window.innerHeight * 0.8);
      const delta = dir === 'up' ? -amt : amt;
      songBodyEl.scrollBy({ top: delta, left: 0, behavior: 'smooth' });
    }

    prevBtn.addEventListener('click', () => navDelta(-1));
    nextBtn.addEventListener('click', () => navDelta(1));
    scrollUpBtn.addEventListener('click', () => scrollByScreen('up'));
    scrollDownBtn.addEventListener('click', () => scrollByScreen('down'));

    // Menu toggle (this is your ‚Äúhide menu / show menu‚Äù)
    function setStageMode(enabled){
      document.body.classList.toggle('stageMode', !!enabled);
      localStorage.setItem('cps_stageMode', enabled ? '1' : '0');

      // When entering stageMode, auto-hide the top header after a short delay
      if (enabled){
        scheduleHeaderAutoHide();
      } else {
        topHeader.classList.remove('autoHidden');
        clearTimeout(headerHideTimer);
      }
    }

    menuBtn.addEventListener('click', () => {
      const enabled = !document.body.classList.contains('stageMode');
      setStageMode(enabled);
    });

    (function initStageMode(){
      const s = localStorage.getItem('cps_stageMode');
      if (s === '1') setStageMode(true);
    })();

    function scheduleHeaderAutoHide(){
      clearTimeout(headerHideTimer);
      // show immediately, then hide after 1.8s
      topHeader.classList.remove('autoHidden');
      headerHideTimer = setTimeout(() => {
        if (document.body.classList.contains('stageMode')){
          topHeader.classList.add('autoHidden');
        }
      }, 1800);
    }

    function nudgeHeaderVisible(){
      if (!document.body.classList.contains('stageMode')) return;
      topHeader.classList.remove('autoHidden');
      scheduleHeaderAutoHide();
    }

    // Tap/move to reveal header in stageMode
    window.addEventListener('mousemove', nudgeHeaderVisible, { passive:true });
    window.addEventListener('touchstart', nudgeHeaderVisible, { passive:true });
    window.addEventListener('scroll', nudgeHeaderVisible, { passive:true });

    // Info modal
    function openInfoModal(){
      if (!LIB) return;

      const persona = personaSelect.value || '';
      const song = CURRENT_UID ? SONG_MAP.get(CURRENT_UID) : null;

      const rows = [];

      rows.push(['Library songs', String((LIB.songs || []).length)]);
      rows.push(['Last consolidated', LIB.lastConsolidated || '‚Äî']);
      rows.push(['Selected persona', persona || '‚Äî']);

      if (USING_COLLECTIONS){
        const col = getCollectionById(CURRENT_COLLECTION_ID);
        const set = col ? getSetFromCollection(col, CURRENT_SET_ID) : null;
        rows.push(['Collection', col ? (col.name || col.id) : '‚Äî']);
        rows.push(['Set', set ? (set.name || set.id) : '‚Äî']);
      } else {
        const sl = findSetlistById(CURRENT_SETLIST_ID);
        rows.push(['Setlist', sl ? (sl.name || sl.id) : '‚Äî']);
      }

      rows.push(['‚Äî', '‚Äî']);
      rows.push(['Current song', song ? (song.title || '(untitled)') : '‚Äî']);
      rows.push(['Artist', song ? (song.artist || '‚Äî') : '‚Äî']);
      rows.push(['Singer', song ? (song.singer || '‚Äî') : '‚Äî']);
      rows.push(['Duration', song ? (song.duration || '‚Äî') : '‚Äî']);
      rows.push(['Tempo', song ? (String(song.tempo ?? '‚Äî')) : '‚Äî']);
      rows.push(['UID', CURRENT_UID || '‚Äî']);

      if (song && song.files){
        const p = persona && song.files[persona] ? song.files[persona] : (song.files._default || '');
        rows.push(['Resolved file', p || '‚Äî']);
      }

      infoKv.innerHTML = '';
      rows.forEach(([k,v]) => {
        if (k === '‚Äî' && v === '‚Äî'){
          const div = document.createElement('div');
          div.className = 'divider';
          div.style.gridColumn = '1 / -1';
          infoKv.appendChild(div);
          return;
        }
        const dk = document.createElement('div');
        dk.className = 'k';
        dk.textContent = k;

        const dv = document.createElement('div');
        dv.className = 'v';
        dv.textContent = v;

        infoKv.appendChild(dk);
        infoKv.appendChild(dv);
      });

      modalBackdrop.style.display = 'flex';
    }

    function closeInfoModal(){
      modalBackdrop.style.display = 'none';
    }

    infoBtn.addEventListener('click', openInfoModal);
    closeModalBtn.addEventListener('click', closeInfoModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeInfoModal();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeInfoModal();
      if (e.key === 'ArrowLeft') navDelta(-1);
      if (e.key === 'ArrowRight') navDelta(1);
    });

    function populatePersonaSelect(){
      const personas = computePersonas();
      personaSelect.innerHTML = '';
      if (!personas.length){
        personaSelect.innerHTML = '<option value="">(none)</option>';
        personaSelect.disabled = true;
        return;
      }
      personas.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        personaSelect.appendChild(opt);
      });

      const saved = localStorage.getItem('cps_persona');
      if (saved && personas.includes(saved)) personaSelect.value = saved;

      personaSelect.disabled = false;
    }

    personaSelect.addEventListener('change', () => {
      localStorage.setItem('cps_persona', personaSelect.value);
      if (CURRENT_UID) openSong(CURRENT_UID);
    });

    async function loadLibrary(){
      // Reset
      songListEl.innerHTML = '';
      emptyState.style.display = 'block';
      songPanel.style.display = 'none';
      floatNav.style.display = 'none';
      CURRENT_UID = null;
      CURRENT_UID_ORDER = [];

      // Hide/select control blocks until we know which mode
      collectionWrap.style.display = 'none';
      setWrap.style.display = 'none';
      setlistWrap.style.display = 'none';

      collectionSelect.disabled = true;
      setSelect.disabled = true;
      setlistSelect.disabled = true;
      personaSelect.disabled = true;

      const url = '../library/library.index.json';

      try{
        LIB = await fetchJSON(url);
        buildSongMap();

        // Decide mode
        USING_COLLECTIONS = Array.isArray(LIB.collections) && LIB.collections.length > 0;

        if (USING_COLLECTIONS){
          collectionWrap.style.display = '';
          setWrap.style.display = '';

          populateCollectionSelect();
          populateSetSelect();

          collectionSelect.addEventListener('change', () => {
            CURRENT_COLLECTION_ID = collectionSelect.value;
            localStorage.setItem('cps_collection', CURRENT_COLLECTION_ID);

            populateSetSelect();

            CURRENT_UID = null;
            renderSidebarStats();
            renderSongList();

            if (CURRENT_UID_ORDER.length){
              const first = CURRENT_UID_ORDER[0];
              if (SONG_MAP.get(first)) openSong(first);
            }
          }, { once:false });

          setSelect.addEventListener('change', () => {
            CURRENT_SET_ID = setSelect.value;
            const key = `cps_set_${CURRENT_COLLECTION_ID || ''}`;
            localStorage.setItem(key, CURRENT_SET_ID);

            CURRENT_UID = null;
            renderSidebarStats();
            renderSongList();

            if (CURRENT_UID_ORDER.length){
              const first = CURRENT_UID_ORDER[0];
              if (SONG_MAP.get(first)) openSong(first);
            }
          }, { once:false });

        } else {
          // fallback to setlists
          ensureVirtualAllSongsSetlist();

          setlistWrap.style.display = '';
          populateSetlistSelect();

          setlistSelect.addEventListener('change', () => {
            CURRENT_SETLIST_ID = setlistSelect.value;
            localStorage.setItem('cps_setlist', CURRENT_SETLIST_ID);

            CURRENT_UID = null;
            renderSidebarStats();
            renderSongList();

            if (CURRENT_UID_ORDER.length){
              const first = CURRENT_UID_ORDER[0];
              if (SONG_MAP.get(first)) openSong(first);
            }
          }, { once:false });
        }

        populatePersonaSelect();
        renderSidebarStats();
        renderSongList();

        // Auto-open first song
        if (CURRENT_UID_ORDER.length){
          const first = CURRENT_UID_ORDER[0];
          if (SONG_MAP.get(first)) openSong(first);
        }

      }catch(e){
        console.error(e);
      }
    }

    refreshBtn.addEventListener('click', loadLibrary);

    // Init
    loadLibrary();
  </script>
</body>
</html>
